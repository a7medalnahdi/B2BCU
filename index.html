<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>صانع الكوبونات - تصميم عصري جديد</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #f96714;
            --primary-color-dark: #e05a12;
            --secondary-color: #121212;
            --text-light: #ffffff;
            --tertiary-color: #64748b;
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            --main-font: 'Cairo', sans-serif;
        }
        .dark-mode {
            --primary-color: #fa7a30;
            --primary-color-dark: #f96714;
            --secondary-color: #e5e7eb;
            --text-light: #e5e7eb;
            --tertiary-color: #94a3b8;
            --bg-color: #020617;
            --card-bg: #1e293b;
            --border-color: #334152;
        }
        * { box-sizing: border-box; margin:0; padding:0;}
        body { 
            font-family: var(--main-font); 
            background: var(--bg-color); 
            color: var(--secondary-color); 
            transition: background-color 0.3s, color 0.3s; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden; /* Prevent body scroll */
        }
        .container { width: 100%; height:100vh; padding: 0; margin: 0; }
        .top-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 24px; 
            background-color: var(--card-bg); 
            border-bottom: 1px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        .top-bar .logo-container { flex: 1; text-align: right; }
        .top-bar .logo { height: 40px; }
        .top-bar .title { flex: 1; text-align: center; font-weight: 700; font-size: 1.2rem; color: var(--secondary-color); }
        .top-bar .controls-container { flex: 1; display: flex; justify-content: flex-end; }

        .main-layout { display: flex; flex-direction: row; padding-top: 65px; height: 100%;}
        
        .left-panel {
            width: 320px;
            padding: 20px;
            background-color: var(--card-bg);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }
        .center-panel {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }
        .right-panel {
            width: 350px;
            background-color: var(--card-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
        }

        .preview-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .preview-container { 
            width: 100%;
            max-width: 800px;
            padding: 16px; 
            border-radius: var(--border-radius); 
            background-color: var(--card-bg); 
            box-shadow: var(--box-shadow); 
            border: 1px solid var(--border-color);
            transition: max-width 0.4s ease-in-out;
        }
        .preview-container.portrait-mode {
             max-width: 450px; /* Constrain width in portrait */
        }

        .preview {
            position: relative;
            border-radius: var(--border-radius);
            width: 100%;
            margin: 0 auto;
            background-color: #e2e8f0;
            aspect-ratio: 1.48 / 1.05; 
            transition: aspect-ratio 0.4s ease-in-out;
        }
        .preview.portrait { aspect-ratio: 1.05 / 1.48; }
        .preview img.bg { width: 100%; height: 100%; display: block; position: absolute; top: 0; left: 0; object-fit: cover; z-index: 1; border-radius: var(--border-radius); }
        .overlay-text { position: absolute; cursor: pointer; user-select: none; padding: 5px 10px; border: 2px solid transparent; border-radius: 6px; z-index: 10; line-height: 1.4; transition: border-color 0.2s, opacity 0.3s; }
        .movable-item { position: absolute; cursor: pointer; user-select: none; z-index: 10; }
        .movable-item.active { outline: 2px solid var(--primary-color); z-index: 20; }
        #logoPreview { width: 100px; height: auto; display: none; transition: opacity 0.2s; top: 5%; right: 5%; }

        .section-title { font-size: 1rem; font-weight: 700; color: var(--secondary-color); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .property-title {
            font-size: 1.1rem;
            font-weight: 700;
            padding-bottom: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .mode-switcher { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; padding: 4px; background-color: var(--bg-color); border-radius: var(--border-radius); }
        .mode-btn { background-color: transparent; border: none; padding: 10px; font-size: 0.9rem; font-weight: 600; border-radius: 8px; cursor: pointer; color: var(--tertiary-color); transition: all 0.3s; display:flex; align-items:center; justify-content:center; gap: 8px;}
        .mode-btn.active { background-color: var(--card-bg); color: var(--primary-color); box-shadow: var(--box-shadow); }
        
        .control-group { margin-bottom: 20px; }
        .control-group label { display: block; font-size: 0.9rem; font-weight: 600; margin-bottom: 8px; color: var(--secondary-color); }
        .control-row { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; margin-top: 12px; }
        input[type="text"], textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.9rem; background: var(--bg-color); color: var(--secondary-color); font-family: var(--main-font); transition: all 0.2s; }
        input:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(249, 103, 20, 0.2); }
        .dark-mode input:focus, .dark-mode textarea:focus { box-shadow: 0 0 0 3px rgba(250, 122, 48, 0.3); }
        .btn-group { display: flex; gap: 8px; }
        .btn-icon { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: var(--border-radius); cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1rem; color: var(--tertiary-color); transition: all 0.2s; }
        .btn-icon:hover { color: var(--secondary-color); border-color: var(--tertiary-color); }
        .btn-icon.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .color-selector-group { display: flex; gap: 10px; }
        .color-selector-group .color-btn { height: 32px; width: 32px; flex-grow: 1; border-radius: 6px;}
        .color-btn.active { box-shadow: 0 0 0 3px var(--primary-color); transform: scale(1.1); }
        .color-btn[data-color="#ffffff"] { border: 1px solid #ddd; }
        
        .slider-control { display: flex; align-items: center; gap: 10px; margin-top: 12px; }
        .slider-control label { font-size: 0.9rem; color: var(--tertiary-color); margin-bottom:0; }
        .slider-control span { min-width: 40px; text-align: right; font-size: 0.9rem; font-weight: 600; }
        
        /* --- التعديل: تصميم جديد لأشرطة التحكم --- */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: var(--border-color);
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            cursor: pointer;
            border-radius: 50%;
            border: none;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }

        .file-label, .btn { cursor: pointer; background: var(--primary-color); color: #fff; border: none; border-radius: var(--border-radius); padding: 12px 16px; font-size:0.95rem; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 600; text-align: center; width: 100%; transition: all 0.2s; }
        .file-label:hover, .btn:hover { background: var(--primary-color-dark); transform: translateY(-2px); box-shadow: 0 7px 10px -3px rgb(0 0 0 / 0.1); }
        .file-label:active, .btn:active { transform: translateY(0); box-shadow: none; }
        input[type="file"] { display: none; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(17, 24, 39, 0.6); color: white; display: none; align-items: center; justify-content: center; flex-direction: column; gap: 15px; z-index: 2000; backdrop-filter: blur(4px); }
        .loader { border: 5px solid #4b5563; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tool-group { margin-top: 24px; }
        .templates-grid-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 10px; }
        .template-thumb { width: 100%; border-radius: var(--border-radius); border: 2px solid var(--border-color); cursor: pointer; transition: all 0.2s ease-in-out; object-fit: cover; }
        #landscape-templates .template-thumb { aspect-ratio: 1.48 / 1.05; }
        #portrait-templates .template-thumb { aspect-ratio: 1.05 / 1.48; }
        .template-thumb:hover { border-color: var(--tertiary-color); transform: scale(1.05); }
        .template-thumb.active { border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-color); transform: scale(1.05); }
        
        .property-panel { display: none; }
        .property-panel.active { display: block; }
        #properties-placeholder { text-align: center; color: var(--tertiary-color); padding-top: 40px;}
        #properties-placeholder i { font-size: 3rem; margin-bottom: 1rem; }
        
        #notification-container { position: fixed; bottom: 20px; left: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .toast { display: flex; align-items: center; padding: 15px 20px; border-radius: var(--border-radius); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); color: white; min-width: 320px; opacity: 0; transform: translateX(-120%); transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.hide { opacity: 0; visibility: hidden; transform: translateX(-120%);}
        .toast i.fa-solid { font-size: 1.5rem; margin-left: 15px; }
        .toast .toast-content { flex-grow: 1; }
        .toast .toast-title { font-weight: 700; font-size: 1rem; }
        .toast .toast-message { font-size: 0.9rem; opacity: 0.9; }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
        .toast.warning { background-color: var(--primary-color); }
        .toast .close-btn { background: none; border: none; color: white; cursor: pointer; font-size: 1.5rem; padding: 0 5px; opacity: 0.7; transition: opacity 0.2s; }
        .toast .close-btn:hover { opacity: 1; }
        
        .theme-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider .sun-icon, .slider .moon-icon { position: absolute; top: 50%; transform: translateY(-50%); color: var(--primary-color); transition: opacity 0.4s; }
        .slider .sun-icon { left: 8px; opacity: 1; }
        .slider .moon-icon { right: 8px; opacity: 0; }
        input:checked + .slider .sun-icon { opacity: 0; }
        input:checked + .slider .moon-icon { opacity: 1; color: white; }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="logo-container">
            <!-- ضع رابط شعارك هنا -->
            <img src="https://i.ibb.co/qLNFj53h/Logo-2.png" alt="شعار الشركة" class="logo">
        </div>
        <div class="title"> تصدير الكوبونات </div>
        <div class="controls-container">
            <label class="theme-switch">
                <input type="checkbox" id="themeToggleCheckbox">
                <span class="slider round">
                     <i class="fa-solid fa-sun sun-icon"></i>
                     <i class="fa-solid fa-moon moon-icon"></i>
                </span>
            </label>
        </div>
    </div>

    <div class="container">
        <div class="main-layout">
            <!-- Right Panel (Inspector) -->
            <div class="right-panel" id="propertiesInspector">
                <div id="properties-placeholder">
                    <i class="fa-solid fa-hand-pointer"></i>
                    <p>اختر عنصراً لتعديله</p>
                </div>

                <div id="text-properties" class="property-panel">
                    <h3 id="property-title-text" class="property-title"></h3>
                    <div class="control-group">
                        <label for="text-input">المحتوى</label>
                        <textarea id="text-input" rows="2"></textarea>
                    </div>
                    <div class="control-group">
                         <label>اللون</label>
                         <div class="color-selector-group" id="text-color-selector">
                            <button class="btn-icon color-btn" data-color="#121212" style="background-color:#121212;"></button>
                            <button class="btn-icon color-btn" data-color="#ffffff" style="background-color:#ffffff;"></button>
                            <button class="btn-icon color-btn" data-color="#f96714" style="background-color:#f96714;"></button>
                         </div>
                    </div>
                     <div class="control-group">
                        <label>الحجم والوزن</label>
                        <div class="slider-control"><input type="range" class="font-size-slider" min="8" max="120"><span class="font-size-value"></span></div>
                        <div class="control-row" style="margin-top: 15px;">
                            <label>خط عريض</label>
                            <button class="btn-icon bold-toggle-btn" title="خط عريض"><i class="fa-solid fa-bold"></i></button>
                        </div>
                     </div>
                </div>

                 <div id="logo-properties" class="property-panel">
                    <h3 class="property-title">خصائص الشعار</h3>
                    <div class="control-group">
                        <div class="slider-control"><label>الحجم</label><input type="range" id="logoSizeSlider" min="20" max="300"><span id="logoSizeValue"></span></div>
                    </div>
                     <div class="tool-group">
                         <button class="btn" id="removeLogoBtn" style="background-color: var(--danger-color);"><i class="fa-solid fa-trash"></i>&nbsp;حذف الشعار</button>
                     </div>
                </div>
            </div>
            
            <!-- Center Panel (Canvas) -->
            <div class="center-panel">
                <div class="preview-wrapper">
                     <div class="preview-container">
                        <div class="preview" id="previewArea">
                            <img id="backgroundImage" class="bg" src="https://i.ibb.co/dG0G2pB/coupon-bg-1.png"/>
                            <div id="mainText" data-name="النص الأساسي" data-centered="true" class="overlay-text movable-item selectable" style="top: 20%; left: 50%; transform: translateX(-50%); font-size: 32px; color: #121212; font-family: var(--main-font); font-weight: 700; text-align: center;">النص الأساسي</div>
                            <div id="subText" data-name="النص الفرعي" data-centered="true" class="overlay-text movable-item selectable" style="top: 38%; left: 50%; transform: translateX(-50%); font-size: 20px; color: #121212; font-family: var(--main-font); font-weight: 400; text-align: center;">النص الفرعي</div>
                            <div id="codeText" data-name="الكود" data-centered="true" class="overlay-text movable-item selectable" style="top: 55%; left: 50%; transform: translateX(-50%); font-size: 40px; color: var(--primary-color); font-family: var(--main-font); font-weight: 800; text-align: center;">CODE-123</div>
                            <div id="termsText" data-name="الشروط والأحكام" data-centered="true" class="overlay-text movable-item selectable" style="top: 88%; left: 50%; transform: translateX(-50%); font-size: 12px; color: #6b7280; font-family: var(--main-font); font-weight: 400; text-align: center;">الشروط والأحكام</div>
                            <img id="logoPreview" data-name="الشعار" class="movable-item selectable" src="" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Left Panel (Tools) -->
            <div class="left-panel">
                 <div class="mode-switcher">
                    <button id="show-single" class="mode-btn active">كوبون فردي</button>
                    <button id="show-batch" class="mode-btn">مجموعة كوبونات</button>
                </div>

                <div id="single-designer-panel">
                    <div class="control-group">
                        <label>الخلفية والشعار</label>
                        <div style="display:flex; gap:12px;">
                            <label class="file-label" style="flex:1;"><input type="file" id="backgroundUpload" accept="image/*"><i class="fa-solid fa-image"></i> الخلفية</label>
                            <label class="file-label" style="flex:1;"><input type="file" id="logoUpload" accept="image/*"><i class="fa-solid fa-upload"></i> الشعار</label>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>اتجاه التصميم (A6)</label>
                        <div class="mode-switcher" style="margin-bottom:0;">
                            <button id="orientation-landscape" class="mode-btn active"><i class="fa-solid fa-arrows-left-right-to-line"></i>&nbsp;عرضي</button>
                            <button id="orientation-portrait" class="mode-btn"><i class="fa-solid fa-arrows-up-down"></i>&nbsp;طولي</button>
                        </div>
                   </div>
                    <div class="control-group">
                        <label id="templates-section-title">قوالب عرضية</label>
                        <div id="landscape-templates" class="templates-grid-container"></div>
                        <div id="portrait-templates" class="templates-grid-container" style="display: none;"></div>
                    </div>
                     <div class="tool-group">
                        <label>تصدير الكوبون الحالي</label>
                        <div style="display:flex; gap:12px;">
                             <button class="btn" id="downloadPngBtn" style="background-color: var(--success-color); flex: 1;"><i class="fa-solid fa-file-image"></i> PNG</button>
                             <button class="btn" id="downloadPdfBtn" style="background-color: var(--danger-color); flex: 1;"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                        </div>
                     </div>
                </div>

                <div id="batch-producer-panel" style="display: none;">
                    <div class="section-title">إنتاج مجموعة كوبونات</div>
                     <p style="font-size:0.85rem; color: var(--tertiary-color); margin-bottom:15px; line-height:1.6;">
                        <b>ملاحظة:</b> سيتم استخدام التصميم الحالي كقالب لجميع الكوبونات.
                     </p>
                    <div class="tool-group">
                        <label class="file-label" style="background-color: var(--primary-color);"><input type="file" id="batchFileUpload" accept=".xlsx, .xls, .csv"><i class="fa-solid fa-file-excel"></i> <span id="fileName">اختر ملف الأكواد</span></label>
                         <p style="font-size:0.8rem; color: var(--tertiary-color); margin-top:8px;">(ملف Excel أو CSV بعمود واحد)</p>
                    </div>
                    <div class="tool-group">
                        <button class="btn" id="generatePdfBtn" style="background-color: var(--success-color);"><i class="fa-solid fa-file-pdf"></i> إنشاء وتصدير PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="loadingOverlay" class="loading-overlay"><div class="loader"></div><p>جاري إنشاء الكوبونات...</p></div>
    <div id="notification-container"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const templates = {
            landscape: [
                { id: 'l1', thumb: 'https://i.ibb.co/dG0G2pB/coupon-bg-1.png', full: 'https://i.ibb.co/dG0G2pB/coupon-bg-1.png' },
                { id: 'l2', thumb: 'https://i.ibb.co/yWRgD2G/coupon-bg-2.png', full: 'https://i.ibb.co/yWRgD2G/coupon-bg-2.png' },
                { id: 'l3', thumb: 'https://i.ibb.co/xJFS4gX/coupon-bg-3.png', full: 'https://i.ibb.co/xJFS4gX/coupon-bg-3.png' }
            ],
            portrait: [
                { id: 'p1', thumb: 'https://i.ibb.co/Hpx5QBBq/Artboard-1.png', full: 'https://i.ibb.co/Hpx5QBBq/Artboard-1.png' },
                { id: 'p2', thumb: 'https://i.ibb.co/Hpx5QBBq/Artboard-1.png', full: 'https://i.ibb.co/Hpx5QBBq/Artboard-1.png' },
                { id: 'p3', thumb: 'https://i.ibb.co/Hpx5QBBq/Artboard-1.png', full: 'https://i.ibb.co/Hpx5QBBq/Artboard-1.png' }
            ]
        };

        const elements = {
            themeToggleCheckbox: document.getElementById('themeToggleCheckbox'),
            previewContainer: document.querySelector('.preview-container'),
            previewArea: document.getElementById('previewArea'),
            backgroundImage: document.getElementById('backgroundImage'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            downloadPngBtn: document.getElementById('downloadPngBtn'),
            downloadPdfBtn: document.getElementById('downloadPdfBtn'), 
            showSingleBtn: document.getElementById('show-single'),
            showBatchBtn: document.getElementById('show-batch'),
            singleDesignerPanel: document.getElementById('single-designer-panel'),
            batchProducerPanel: document.getElementById('batch-producer-panel'),
            orientationLandscapeBtn: document.getElementById('orientation-landscape'),
            orientationPortraitBtn: document.getElementById('orientation-portrait'),
            landscapeTemplatesContainer: document.getElementById('landscape-templates'),
            portraitTemplatesContainer: document.getElementById('portrait-templates'),
            templatesSectionTitle: document.getElementById('templates-section-title'),
            propertiesInspector: document.getElementById('propertiesInspector'),
            propertiesPlaceholder: document.getElementById('properties-placeholder'),
            textPropertiesPanel: document.getElementById('text-properties'),
            logoPropertiesPanel: document.getElementById('logo-properties'),
            propertyTitleText: document.getElementById('property-title-text'),
            textInput: document.getElementById('text-input'),
            textColorSelector: document.getElementById('text-color-selector'),
            fontSizeSlider: document.querySelector('#text-properties .font-size-slider'),
            fontSizeValue: document.querySelector('#text-properties .font-size-value'),
            boldToggleBtn: document.querySelector('#text-properties .bold-toggle-btn'),
            logoSizeSlider: document.getElementById('logoSizeSlider'),
            logoSizeValue: document.getElementById('logoSizeValue'),
            removeLogoBtn: document.getElementById('removeLogoBtn'),
            backgroundUpload: document.getElementById('backgroundUpload'),
            logoUpload: document.getElementById('logoUpload'),
            batchFileUpload: document.getElementById('batchFileUpload'),
            fileName: document.getElementById('fileName'),
            generatePdfBtn: document.getElementById('generatePdfBtn'),
            selectableElements: document.querySelectorAll('.selectable')
        };
        
        let activeElement = null;
        let couponCodes = [];
        const notificationContainer = document.getElementById('notification-container');

        // --- Notification System ---
        function showNotification(type = 'success', title, message) {
            const toast = document.createElement('div');
            toast.classList.add('toast', type);
            const icons = { success: 'fa-check-circle', error: 'fa-times-circle', warning: 'fa-exclamation-triangle' };
            toast.innerHTML = `
                <i class="fa-solid ${icons[type]}"></i>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="close-btn">&times;</button>`;
            notificationContainer.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            const hideTimeout = setTimeout(() => { toast.classList.add('hide'); setTimeout(() => toast.remove(), 400); }, 5000);
            toast.querySelector('.close-btn').addEventListener('click', () => {
                clearTimeout(hideTimeout);
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 400);
            });
        }

        // --- Mode Switcher Logic ---
        elements.showSingleBtn.addEventListener('click', () => {
            elements.singleDesignerPanel.style.display = 'block';
            elements.batchProducerPanel.style.display = 'none';
            elements.showSingleBtn.classList.add('active');
            elements.showBatchBtn.classList.remove('active');
        });
        elements.showBatchBtn.addEventListener('click', () => {
            elements.singleDesignerPanel.style.display = 'none';
            elements.batchProducerPanel.style.display = 'block';
            elements.showSingleBtn.classList.remove('active');
            elements.showBatchBtn.classList.add('active');
        });
        
        // --- Orientation & Templates Logic ---
        const setOrientation = (orientation) => {
            const isLandscape = orientation === 'landscape';
            elements.previewArea.classList.toggle('portrait', !isLandscape);
            elements.previewContainer.classList.toggle('portrait-mode', !isLandscape);
            elements.orientationLandscapeBtn.classList.toggle('active', isLandscape);
            elements.orientationPortraitBtn.classList.toggle('active', !isLandscape);
            elements.landscapeTemplatesContainer.style.display = isLandscape ? 'grid' : 'none';
            elements.portraitTemplatesContainer.style.display = isLandscape ? 'none' : 'grid';
            elements.templatesSectionTitle.textContent = isLandscape ? 'قوالب عرضية' : 'قوالب طولية';
            if (isLandscape && !document.querySelector('#landscape-templates .template-thumb.active')) {
                applyTemplate(templates.landscape[0].full, 'l1');
            } else if (!isLandscape && !document.querySelector('#portrait-templates .template-thumb.active')) {
                applyTemplate(templates.portrait[0].full, 'p1');
            }
        };
        elements.orientationLandscapeBtn.addEventListener('click', () => setOrientation('landscape'));
        elements.orientationPortraitBtn.addEventListener('click', () => setOrientation('portrait'));

        const applyTemplate = (fullUrl, templateId) => {
            elements.backgroundImage.src = fullUrl;
            document.querySelectorAll('.template-thumb').forEach(t => t.classList.remove('active'));
            const newActive = document.querySelector(`[data-id="${templateId}"]`);
            if (newActive) newActive.classList.add('active');
        };

        const renderTemplates = () => {
            ['landscape', 'portrait'].forEach(type => {
                const container = (type === 'landscape') ? elements.landscapeTemplatesContainer : elements.portraitTemplatesContainer;
                container.innerHTML = '';
                templates[type].forEach(t => {
                    const img = document.createElement('img');
                    img.src = t.thumb;
                    img.dataset.id = t.id;
                    img.classList.add('template-thumb');
                    img.addEventListener('click', () => applyTemplate(t.full, t.id));
                    container.appendChild(img);
                });
            });
            applyTemplate(templates.landscape[0].full, 'l1');
        };

        // --- Properties Inspector Logic ---
        function showPropertiesFor(element) {
            elements.propertiesPlaceholder.style.display = 'none';
            elements.textPropertiesPanel.classList.remove('active');
            elements.logoPropertiesPanel.classList.remove('active');
            elements.selectableElements.forEach(el => el.classList.remove('active'));
            
            if (!element) {
                 elements.propertiesPlaceholder.style.display = 'block';
                 activeElement = null;
                 return;
            }

            activeElement = element;
            activeElement.classList.add('active');

            if (activeElement.classList.contains('overlay-text')) {
                updateTextPropertiesPanel();
                elements.textPropertiesPanel.classList.add('active');
            } else if (activeElement.id === 'logoPreview') {
                updateLogoPropertiesPanel();
                elements.logoPropertiesPanel.classList.add('active');
            }
        }

        function updateTextPropertiesPanel() {
            if (!activeElement) return;
            const style = window.getComputedStyle(activeElement);
            elements.propertyTitleText.textContent = `خصائص: ${activeElement.dataset.name}`;
            elements.textInput.value = activeElement.innerHTML.replace(/<br\s*\/?>/gi, "\n");
            elements.fontSizeSlider.value = parseInt(style.fontSize, 10);
            elements.fontSizeValue.textContent = `${parseInt(style.fontSize, 10)}px`;
            elements.boldToggleBtn.classList.toggle('active', parseInt(style.fontWeight) >= 700);
            
            const rgbToHex = (rgb) => {
              if (!rgb || !rgb.includes('rgb')) return '#000000';
              let [r, g, b] = rgb.match(/\d+/g).map(Number);
              return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toLowerCase();
            }

            const currentColor = rgbToHex(style.color);
            elements.textColorSelector.querySelectorAll('.color-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.color.toLowerCase() === currentColor);
            });
        }
        
        function updateLogoPropertiesPanel() {
            if (!activeElement) return;
            elements.logoSizeSlider.value = parseInt(activeElement.style.width, 10) || 100;
            elements.logoSizeValue.textContent = `${elements.logoSizeSlider.value}px`;
        }

        elements.selectableElements.forEach(el => {
            el.addEventListener('click', (e) => {
                e.stopPropagation();
                showPropertiesFor(el);
            });
        });
        
        document.body.addEventListener('click', (e) => {
            if (!elements.propertiesInspector.contains(e.target) && !e.target.classList.contains('selectable')) {
                showPropertiesFor(null);
            }
        });

        // --- Text Control Event Listeners ---
        elements.textInput.addEventListener('input', () => { if (activeElement) activeElement.innerHTML = elements.textInput.value.replace(/\n/g, '<br>'); });
        elements.fontSizeSlider.addEventListener('input', () => { if (activeElement) { activeElement.style.fontSize = `${elements.fontSizeSlider.value}px`; elements.fontSizeValue.textContent = `${elements.fontSizeSlider.value}px`; } });
        elements.boldToggleBtn.addEventListener('click', () => { if (activeElement) { const isBold = (window.getComputedStyle(activeElement).fontWeight) >= 700; activeElement.style.fontWeight = isBold ? '400' : '800'; elements.boldToggleBtn.classList.toggle('active', !isBold); } });
        elements.textColorSelector.addEventListener('click', (e) => { const btn = e.target.closest('.color-btn'); if (activeElement && btn) { activeElement.style.color = btn.dataset.color; updateTextPropertiesPanel(); } });

        // --- Logo Control Event Listeners ---
        elements.logoSizeSlider.addEventListener('input', () => { if (activeElement) { activeElement.style.width = `${elements.logoSizeSlider.value}px`; updateLogoPropertiesPanel();} });
        
        // --- General Controls Logic ---
        const handleFileUpload = (event, onRead) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = e => onRead(e.target.result); reader.readAsDataURL(file); };
        elements.backgroundUpload.addEventListener('change', e => { handleFileUpload(e, (result) => { elements.backgroundImage.src = result; document.querySelectorAll('.template-thumb').forEach(t => t.classList.remove('active')); }); });
        elements.logoUpload.addEventListener('change', e => handleFileUpload(e, (result) => { const logo = document.getElementById('logoPreview'); logo.src = result; logo.style.display = 'block'; showPropertiesFor(logo); }));
        elements.removeLogoBtn.addEventListener('click', () => { const logo = document.getElementById('logoPreview'); logo.src = ''; logo.style.display = 'none'; showPropertiesFor(null); });

        // --- Export & Theme ---
        const performExport = async (exportFunction) => {
            showPropertiesFor(null);
            await new Promise(res => setTimeout(res, 50));
            elements.loadingOverlay.style.display = 'flex';

            const previewOriginalRadius = elements.previewArea.style.borderRadius;
            const bgOriginalRadius = elements.backgroundImage.style.borderRadius;
            elements.previewArea.style.borderRadius = '0px';
            elements.backgroundImage.style.borderRadius = '0px';
            
            try {
                await exportFunction();
            } catch (err) {
                console.error('Export error:', err);
                showNotification('error', 'خطأ في التصدير', 'حدث خطأ غير متوقع أثناء عملية التصدير.');
            } finally {
                elements.loadingOverlay.style.display = 'none';
                elements.previewArea.style.borderRadius = previewOriginalRadius;
                elements.backgroundImage.style.borderRadius = bgOriginalRadius;
            }
        };

        elements.downloadPngBtn.addEventListener('click', () => {
            performExport(async () => {
                 const canvas = await html2canvas(elements.previewArea, { scale: 3, useCORS: true, backgroundColor: null, allowTaint: true }); 
                 const link = document.createElement('a'); 
                 link.download = `coupon-${Date.now()}.png`; 
                 link.href = canvas.toDataURL('image/png'); 
                 link.click(); 
            });
        });
        
        elements.downloadPdfBtn.addEventListener('click', () => {
            performExport(async () => {
                const { jsPDF } = window.jspdf;
                const isPortrait = elements.previewArea.classList.contains('portrait');
                const orientation = isPortrait ? 'p' : 'l';
                const width = elements.previewArea.offsetWidth;
                const height = elements.previewArea.offsetHeight;

                const pdf = new jsPDF({ orientation, unit: 'px', format: [width, height] });
                const canvas = await html2canvas(elements.previewArea, { scale: 2, useCORS: true, backgroundColor: null, allowTaint: true });
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 0, 0, width, height);
                pdf.save(`coupon-single-${Date.now()}.pdf`);
            });
        });
        
        elements.themeToggleCheckbox.addEventListener('change', () => {
             document.body.classList.toggle('dark-mode');
        });

        // --- Batch Processing (FIXED) ---
        elements.batchFileUpload.addEventListener('change', (event) => {
            const file = event.target.files[0]; if (!file) return;
            elements.fileName.textContent = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    couponCodes = json.map(row => row[0]).filter(code => code != null && String(code).trim() !== '');
                    if (couponCodes.length > 0) {
                       const codeTextElement = document.getElementById('codeText');
                       codeTextElement.textContent = couponCodes[0];
                       showNotification('success', 'نجاح', `تم تحميل ${couponCodes.length} كود بنجاح.`);
                    } else { 
                       showNotification('error', 'خطأ', 'لم يتم العثور على أكواد صالحة في الملف.');
                    }
                } catch (err) { 
                    console.error(err); 
                    showNotification('error', 'خطأ في الملف', 'فشل قراءة الملف، الرجاء التأكد من الصيغة.');
                }
            };
            reader.readAsArrayBuffer(file);
        });

        elements.generatePdfBtn.addEventListener('click', () => {
             if (couponCodes.length === 0) {
                 showNotification('warning', 'تنبيه', 'الرجاء رفع ملف يحتوي على أكواد أولاً.');
                 return;
             }
             
             performExport(async () => {
                const isPortrait = elements.previewArea.classList.contains('portrait');
                const orientation = isPortrait ? 'p' : 'l';
                const width = elements.previewArea.offsetWidth;
                const height = elements.previewArea.offsetHeight;
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: orientation, unit: 'px', format: [width, height] });
                const codeTextElement = document.getElementById('codeText');
                const originalCode = codeTextElement.textContent;
                
                for (let i = 0; i < couponCodes.length; i++) {
                    codeTextElement.textContent = couponCodes[i];
                    await new Promise(res => setTimeout(res, 50));
                    const canvas = await html2canvas(elements.previewArea, { scale: 2, useCORS: true, backgroundColor: null, allowTaint: true });
                    const imgData = canvas.toDataURL('image/png');
                    if (i > 0) pdf.addPage([width, height], orientation);
                    pdf.addImage(imgData, 'PNG', 0, 0, width, height);
                }
                pdf.save(`coupons-batch-A6-${Date.now()}.pdf`);
                codeTextElement.textContent = originalCode;
            });
        });
        
        // --- Movable Items (FINAL FIX - REBUILT) ---
        document.querySelectorAll('.movable-item').forEach(element => {
            let isDragging = false;
            let startPosX, startPosY, startElemX, startElemY;

            const getPointerPosition = (e) => e.type.includes('touch') ? e.touches[0] : e;

            function onDragStart(e) {
                e.preventDefault();
                showPropertiesFor(element);
                isDragging = true;
                
                if (element.id === 'logoPreview') {
                    element.style.right = 'auto';
                }

                const pointer = getPointerPosition(e);
                startPosX = pointer.clientX;
                startPosY = pointer.clientY;
                startElemX = element.offsetLeft;
                startElemY = element.offsetTop;
                
                element.style.willChange = 'transform';
                document.addEventListener('mousemove', onDragMove);
                document.addEventListener('touchmove', onDragMove, { passive: false });
                document.addEventListener('mouseup', onDragEnd);
                document.addEventListener('touchend', onDragEnd);
            }

            function onDragMove(e) {
                if (!isDragging) return;
                e.preventDefault();
                
                const pointer = getPointerPosition(e);
                const deltaX = pointer.clientX - startPosX;
                const deltaY = pointer.clientY - startPosY;
                
                element.style.left = `${startElemX + deltaX}px`;
                element.style.top = `${startElemY + deltaY}px`;
                
                if (element.dataset.centered === 'true') {
                    element.style.transform = '';
                    element.dataset.centered = 'false';
                }
            }

            function onDragEnd() {
                isDragging = false;
                element.style.willChange = 'auto';
                document.removeEventListener('mousemove', onDragMove);
                document.removeEventListener('touchmove', onDragMove);
                document.removeEventListener('mouseup', onDragEnd);
                document.removeEventListener('touchend', onDragEnd);
            }

            element.addEventListener('mousedown', onDragStart);
            element.addEventListener('touchstart', onDragStart, { passive: false });
        });

        // --- Initialise App ---
        renderTemplates();
        setOrientation('landscape');
        showPropertiesFor(null);
    });
    </script>
</body>
</html>
