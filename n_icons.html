<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Simple Design Studio - SWEATER</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&family=Merriweather:400,700&display=swap" rel="stylesheet">

    <style>
        /* CSS starts here */

        :root {
            --primary-color: #f96714;
            --primary-color-dark: #e05a12;
            --secondary-color: #1a1a1a;
            --text-light: #ffffff;
            --tertiary-color: #6a7f9a;
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-color: #f8faff;
            --card-bg: #ffffff;
            --border-radius: 12px;
            --box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            --main-font: 'Cairo', sans-serif;
            --border-color: #e0eaf3; /* Define border-color for consistency */
            --light-grey: #f0f4f8; /* Added for softer backgrounds */
            --dark-grey: #555; /* For text/icons */

            --side-panel-width: 300px; /* Width for the new side panels */
            --controls-menu-width: 120px; /* Width for the new left menu */
            --text-panel-width: 280px; /* Existing right panel width */
            --gap-spacing: 20px;
        }

        * { 
            box-sizing: border-box; 
            margin:0; 
            padding:0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        body { 
            font-family: var(--main-font); 
            background: var(--bg-color); 
            color: var(--secondary-color); 
            transition: background-color 0.3s, color 0.3s; 
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .top-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px 30px; 
            background-color: var(--card-bg); 
            border-bottom: 1px solid var(--border-color);
            position: sticky; 
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        .back-link {
            font-size: 1rem;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .back-link:hover { text-decoration: underline; }
        .top-bar .title { 
            flex: 1; 
            text-align: center; 
            font-weight: 700; 
            font-size: 1.3rem; 
            color: var(--secondary-color); 
        }
        .top-bar .controls-container { flex: 1; display: flex; justify-content: flex-end; }

        .main-container {
            display: flex;
            flex-grow: 1;
            padding: var(--gap-spacing);
            gap: var(--gap-spacing);
            justify-content: center;
            flex-wrap: nowrap; 
            align-items: flex-start; 
        }

        /* New Left Controls Menu (instead of the old controls-panel) */
        .controls-panel-menu {
            flex-shrink: 0;
            width: var(--controls-menu-width);
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 15px 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border: 1px solid var(--border-color);
            position: sticky; 
            top: calc(50px + var(--gap-spacing)); 
            order: 1; 
            height: fit-content; /* Adjust height to content */
        }

        .controls-panel-menu .menu-btn {
            background: var(--light-grey);
            color: var(--secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 8px; /* Slightly smaller radius for buttons */
            padding: 10px 8px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .controls-panel-menu .menu-btn i {
            font-size: 1.3rem; /* Larger icon size */
            margin-bottom: 3px;
            color: var(--tertiary-color);
        }
        .controls-panel-menu .menu-btn:hover {
            background-color: #e0eaf3;
            color: var(--primary-color-dark);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .controls-panel-menu .menu-btn.active {
            background-color: var(--primary-color);
            color: var(--text-light);
            border-color: var(--primary-color);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.15);
        }
        .controls-panel-menu .menu-btn.active i {
            color: var(--text-light);
        }


        .text-controls-panel {
            flex-shrink: 0;
            width: var(--text-panel-width);
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 100px); 
            display: flex;
            flex-direction: column;
            gap: 15px; 
            border: 1px solid var(--border-color);
            position: sticky; 
            top: calc(50px + var(--gap-spacing)); 
            order: 3; 
        }

        .design-area {
            flex-grow: 1;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            min-height: 400px;
            /* Adjust width to account for new menu and fixed right panel */
            width: calc(100% - var(--text-panel-width) - var(--controls-menu-width) - (var(--gap-spacing) * 2)); 
            border: 1px solid var(--border-color);
            order: 2; 
        }
        #designCanvas {
            border: 1px solid var(--border-color);
            background-color: #f0f0f0;
            max-width: 100%;
            max-height: 100%;
            display: block;
        }

        /* No longer used for sections that are now side panels */
        .section-title, .section-content {
            /* Keep for text-controls-panel only */
        }
        .section-title { 
            font-size: 1.05rem;
            font-weight: 700; 
            color: var(--secondary-color); 
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color); 
            cursor: pointer; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: all 0.2s ease;
            margin-bottom: 0; 
        }
        .section-title:hover {
            color: var(--primary-color); 
        }
        .section-title i { 
            display: inline-block; 
            transition: transform 0.3s ease;
            font-size: 0.8em;
            color: var(--tertiary-color);
        }
        .section-title.collapsed i.fa-chevron-down {
            transform: rotate(-90deg);
        }
        .section-content {
            overflow: hidden; 
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0; 
            opacity: 0; 
            padding-bottom: 0; 
            border-bottom: none; 
        }
        .section-content:not(.hidden) {
            opacity: 1;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--border-color);
        }
        /* Adjusted for new structure */
        .text-controls-panel .section-content:last-of-type { 
            border-bottom: none;
            padding-bottom: 0;
        }
        .section-content:not(.hidden) + .section-title {
            margin-top: 15px; 
        }
        .control-group { 
            margin-bottom: 10px;
            padding-top: 5px;
        }
        .control-group:last-of-type {
            margin-bottom: 0; 
        }


        input[type="text"], input[type="number"], select, textarea { 
            width: 100%; 
            padding: 10px 12px; 
            border: 1px solid var(--border-color); 
            border-radius: var(--border-radius); 
            font-size: 0.9rem; 
            background: var(--light-grey);
            color: var(--secondary-color); 
            font-family: var(--main-font); 
            transition: all 0.2s; 
            resize: vertical; 
            min-height: 40px; 
        }
        /* Make file input truly hidden */
        input[type="file"] {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
            opacity: 0; /* Ensure complete invisibility */
            pointer-events: none; /* Make sure it doesn't interfere with clicks */
            z-index: -1; /* Send it to the background */
        }
        .custom-file-input-btn {
            cursor: pointer;
            background: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: var(--border-radius);
            padding: 12px 16px;
            font-size:0.95rem; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            font-weight: 600; 
            text-align: center; 
            width: 100%; 
            transition: all 0.2s; 
        }
        .custom-file-input-btn:hover {
            background: var(--primary-color-dark);
            transform: translateY(-2px);
            box-shadow: 0 7px 10px -3px rgba(0, 0, 0, 0.1);
        }
        .custom-file-input-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }
       
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: var(--primary-color); 
            box-shadow: 0 0 0 3px rgba(249, 103, 20, 0.2); 
            background: var(--card-bg);
        }
        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 100%;
            height: 40px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            padding: 0;
            overflow: hidden;
            background: var(--light-grey);
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: var(--border-radius);
        }
        input[type="color"]::-moz-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-moz-color-swatch {
            border: none;
            border-radius: var(--border-radius);
        }
        input[type="color"]:hover {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(249, 103, 20, 0.2); 
        }

        /* Range input for opacity */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: var(--light-grey);
            border-radius: 5px;
            outline: none;
            margin: 10px 0;
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background-color 0.2s, box-shadow 0.2s;
            margin-top: -6px;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background-color 0.2s, box-shadow 0.2s;
        }

        input[type="range"]:hover::-webkit-slider-thumb,
        input[type="range"]:focus::-webkit-slider-thumb {
            background: var(--primary-color-dark);
            box-shadow: 0 0 0 3px rgba(249, 103, 20, 0.2);
        }
        input[type="range"]:hover::-moz-range-thumb,
        input[type="range"]:focus::-moz-range-thumb {
            background: var(--primary-color-dark);
            box-shadow: 0 0 0 3px rgba(249, 103, 20, 0.2);
        }


        .btn { 
            cursor: pointer; 
            background: var(--primary-color); 
            color: #fff; 
            border: none; 
            border-radius: var(--border-radius); 
            padding: 12px 16px; 
            font-size:0.95rem; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            font-weight: 600; 
            text-align: center; 
            width: 100%; 
            transition: all 0.2s; 
        }
        .btn:hover { 
            background: var(--primary-color-dark); 
            transform: translateY(-2px); 
            box-shadow: 0 7px 10px -3px rgb(0 0 0 / 0.1); 
        }
        .btn:active { 
            transform: translateY(0); 
            box-shadow: none; 
        }
        .btn.secondary {
            background-color: var(--tertiary-color);
        }
        .btn.secondary:hover {
            background-color: #5a6e87;
        }
        .btn.danger {
            background-color: var(--danger-color);
        }
        .btn.danger:hover {
            background-color: #c0392b;
        }
        .btn.success {
            background-color: var(--success-color);
        }
        .btn.success:hover {
            background-color: #16a34a;
        }
        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        .btn-group .btn {
            flex: 1;
            min-width: 80px;
            padding: 8px 10px;
            font-size: 0.85rem;
            gap: 5px;
        }
        .btn-group .icon-btn {
            padding: 8px;
            width: 40px;
            height: 40px;
            flex-grow: 0;
            border-radius: 8px;
        }
        .btn.active {
            background-color: var(--primary-color-dark);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            transform: translateY(0);
        }
        .btn.text-control {
            background-color: var(--light-grey);
            color: var(--secondary-color);
            font-weight: 700;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            box-shadow: none;
            transform: none;
        }
        .btn.text-control:hover {
            background-color: #e0eaf3;
            box-shadow: none;
            transform: none;
        }
        .btn.text-control.active {
            background-color: var(--primary-color);
            color: var(--text-light);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }

        /* Styles for loading state */
        .btn.loading {
            cursor: not-allowed;
            opacity: 0.7;
            pointer-events: none;
        }

        .btn.loading i.fa-spinner {
            margin-right: 5px;
        }

        /* Color Swatches - new styling for specific color buttons */
        .color-swatch-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        .color-swatch {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .color-swatch:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .color-swatch.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(249, 103, 20, 0.4);
            transform: scale(1.05);
        }
        /* Specific colors for swatches */
        .color-swatch[data-color="#1a1a1a"] { background-color: #1a1a1a; }
        .color-swatch[data-color="#f96714"] { background-color: #f96714; }
        .color-swatch[data-color="#e05a12"] { background-color: #e05a12; }
        .color-swatch[data-color="#6a7f9a"] { background-color: #6a7f9a; }
        .color-swatch[data-color="#ffffff"] { background-color: #ffffff; border-color: #ccc; }
        .color-swatch[data-color="#22c55e"] { background-color: #22c55e; }
        .color-swatch[data-color="#ef4444"] { background-color: #ef4444; }
        .color-swatch[data-color="#f59e0b"] { background-color: #f59e0b; }


        /* Responsive adjustments for smaller screens */
        @media (max-width: 1024px) { 
            .main-container {
                flex-direction: column;
                padding: 15px;
                gap: 15px;
                align-items: center; 
            }
            /* New menu and text panel stacked on top */
            .controls-panel-menu,
            .text-controls-panel {
                width: 100%;
                max-width: 500px; 
                max-height: none; 
                position: static; 
                top: auto;
            }
            .design-area {
                width: 100%;
                min-height: 300px;
                max-width: 500px;
            }
            /* Order them for mobile: Menu, Text Panel, Design Area */
            .controls-panel-menu { order: 1; }
            .text-controls-panel { order: 2; }
            .design-area { order: 3; }

            .btn-group .btn {
                min-width: unset;
                flex-basis: auto;
            }
            /* All sections start collapsed on small screens, handled by JS */

            /* Side panels should probably be full-width popups on small screens */
            .side-panel-overlay {
                width: 100%;
                right: 0;
                transform: translateX(100%); /* Hidden by default */
            }
            .side-panel {
                width: 100%;
                border-radius: 0;
            }
            .side-panel.show {
                transform: translateX(0);
            }
        }
        /* On larger screens, ensure text controls are always expanded, and main controls are collapsible */
        @media (min-width: 1025px) {
            /* Text Controls Panel - Always expanded on large screens */
            .text-controls-panel .section-title {
                cursor: default; 
                border-bottom: none; 
                padding-bottom: 0;
                margin-bottom: 0;
            }
            .text-controls-panel .section-title i {
                display: none; 
            }
            .text-controls-panel .section-content {
                max-height: none !important; 
                opacity: 1 !important;
                border-bottom: none; 
                padding-bottom: 0;
            }
            .text-controls-panel .control-group:last-of-type { 
                 margin-bottom: 0;
                 padding-bottom: 0;
                 border-bottom: none;
            }

            /* Main Menu on the left */
            .controls-panel-menu {
                position: sticky;
                top: calc(50px + var(--gap-spacing));
                height: fit-content; /* Ensure it doesn't take full height */
            }
        }

        /* --- NEW SIDE PANEL STYLES --- */
        .side-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%; /* Take full width to cover canvas */
            height: 100%;
            background: rgba(0, 0, 0, 0.4); /* Semi-transparent overlay */
            display: flex;
            justify-content: flex-end; /* Push panel to the right */
            align-items: flex-start; /* Align panel to the top */
            z-index: 1000; /* Higher than canvas, lower than modals */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .side-panel-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .side-panel {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius) 0 0 var(--border-radius); /* Rounded left corners only */
            box-shadow: var(--box-shadow);
            width: var(--side-panel-width);
            height: 100%; /* Take full height of the overlay */
            transform: translateX(100%); /* Start hidden off-screen to the right */
            transition: transform 0.3s ease;
            position: relative; /* For close button positioning */
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto; /* Enable scrolling for content */
            border-left: 1px solid var(--border-color); /* Add border for separation */
        }
        
        /* Only show the active side panel */
        .side-panel:not(.show) {
            display: none;
        }


        .side-panel-overlay.show .side-panel.show {
            transform: translateX(0); /* Slide in from the right */
        }

        .side-panel h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--secondary-color);
            font-size: 1.3rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .side-panel h3 i {
            font-size: 1rem;
            color: var(--tertiary-color);
        }

        .side-panel-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .close-side-panel-btn {
            position: absolute;
            top: 15px;
            left: 15px; /* Position on the left inside the panel */
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--tertiary-color);
            cursor: pointer;
            transition: color 0.2s;
            z-index: 10; /* Ensure it's clickable */
        }

        .close-side-panel-btn:hover {
            color: var(--danger-color);
        }


        /* Modal Styles (keep existing) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }

        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--secondary-color);
            font-size: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .modal-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: flex-start;
        }

        .modal-list-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            width: 100px;
            height: 120px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
        }
        .modal-list-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .modal-list-item strong {
            font-size: 0.85rem;
            margin-top: 5px;
            color: var(--secondary-color);
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            width: 100%;
        }
        .modal-list-item span {
            font-size: 0.75rem;
            color: var(--tertiary-color);
            display: block;
            margin-top: 2px;
        }

        .modal-item-thumbnail {
            flex-shrink: 0;
            width: 60px;
            height: 60px;
            background-color: var(--light-grey);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid var(--border-color);
            margin-bottom: 5px;
        }
        .modal-item-thumbnail img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            display: block;
        }
        .modal-item-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            margin-left: 0;
            gap: 0;
        }
        .modal-item-actions .modal-btn.danger {
            background-color: rgba(239, 68, 68, 0.7);
            color: var(--text-light);
            padding: 4px;
            font-size: 0.8rem;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease, background-color 0.2s ease;
        }
        .modal-list-item:hover .modal-item-actions .modal-btn.danger {
            opacity: 1;
        }
        .modal-item-actions .modal-btn.danger:hover {
            background-color: var(--danger-color);
        }

        .modal-btn.load {
            display: none;
        }


        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--tertiary-color);
            cursor: pointer;
            transition: color 0.2s;
        }

        .modal-close-btn:hover {
            color: var(--secondary-color);
        }

        .no-items-message {
            text-align: center;
            color: var(--tertiary-color);
            padding: 20px;
            font-size: 1rem;
        }

        /* --- Notification System Styles --- */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .toast {
            background-color: var(--card-bg);
            color: var(--secondary-color);
            padding: 15px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            gap: 12px;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            min-width: 250px;
            max-width: 350px;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.hide {
            opacity: 0;
            transform: translateY(-20px);
        }

        .toast.success {
            border-left: 5px solid var(--success-color);
        }
        .toast.success i {
            color: var(--success-color);
        }
        .toast.error {
            border-left: 5px solid var(--danger-color);
        }
        .toast.error i {
            color: var(--danger-color);
        }
        .toast.warning {
            border-left: 5px solid var(--warning-color);
        }
        .toast.warning i {
            color: var(--warning-color);
        }
        .toast.info {
            border-left: 5px solid var(--tertiary-color);
        }
        .toast.info i {
            color: var(--tertiary-color);
        }

        .toast .toast-content {
            flex-grow: 1;
        }

        .toast .toast-title {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 2px;
        }

        .toast .toast-message {
            font-size: 0.85rem;
            color: var(--tertiary-color);
        }

        .toast .close-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--tertiary-color);
            cursor: pointer;
            margin-left: 10px;
            padding: 0 5px;
            transition: color 0.2s;
        }

        .toast .close-btn:hover {
            color: var(--secondary-color);
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <a href="./index.html" class="back-link">‚Üê Back to Home</a>
        <div class="title">Simple Design Studio</div>
        <div class="controls-container">
        </div>
    </div>

    <div class="main-container">
        <div class="controls-panel-menu">
            <button class="menu-btn" data-panel-target="projectPanel"><i class="fa-solid fa-file"></i> Project</button>
            <button class="menu-btn" data-panel-target="imagePanel"><i class="fa-solid fa-image"></i> Image</button>
            <button class="menu-btn" data-panel-target="vectorPanel"><i class="fa-solid fa-shapes"></i> Vector Graphics</button>
            <button class="menu-btn" data-panel-target="objectPanel"><i class="fa-solid fa-cube"></i> Object</button>
            <button class="menu-btn" data-panel-target="templatesPanel"><i class="fa-solid fa-star"></i> Templates</button>
            <button class="menu-btn" data-panel-target="exportPanel"><i class="fa-solid fa-download"></i> Export</button>
        </div>

        <div class="design-area">
            <canvas id="designCanvas"></canvas>
        </div>

        <div class="text-controls-panel">
            <div class="section-title" data-target="textControls">Text Properties <i class="fa-solid fa-chevron-down"></i></div>
            <div id="textControls" class="section-content">
                <div class="control-group">
                    <label for="textInput">Text Content:</label>
                    <textarea id="textInput" rows="4" placeholder="Enter text. Use Enter for new lines."></textarea>
                    <button class="btn" id="addTextBtn" title="Add Text" style="margin-top:10px;"><i class="fa-solid fa-plus"></i> Add Text</button>
                </div>
                
                <div class="control-group">
                    <label>Font:</label>
                    <select id="fontFamily">
                        <option value="Cairo">Cairo</option>
                        <option value="Arial">Arial</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Roboto">Roboto</option>
                        <option value="Open Sans">Open Sans</option>
                        <option value="Merriweather">Merriweather</option>
                    </select>
                    <label for="fontSize" style="margin-top:10px;">Size:</label>
                    <input type="number" id="fontSize" value="30" min="10" max="200">
                </div>

                <div class="control-group">
                    <label>Fill Color:</label>
                    <div class="color-swatch-group">
                        <div class="color-swatch active" data-color="#1a1a1a" title="Black"></div>
                        <div class="color-swatch" data-color="#f96714" title="Orange"></div>
                        <div class="color-swatch" data-color="#e05a12" title="Dark Orange"></div>
                        <div class="color-swatch" data-color="#6a7f9a" title="Grey"></div>
                        <div class="color-swatch" data-color="#ffffff" title="White"></div>
                        <div class="color-swatch" data-color="#22c55e" title="Green"></div>
                        <div class="color-swatch" data-color="#ef4444" title="Red"></div>
                        <div class="color-swatch" data-color="#f59e0b" title="Yellow"></div>
                    </div>
                    <input type="color" id="customColorPicker" value="#1a1a1a" style="margin-top: 10px;">
                </div>

                <div class="control-group">
                    <label>Text Formatting:</label>
                    <div class="btn-group" style="margin-top:0; justify-content: space-between;"> 
                        <button class="btn icon-btn text-control" id="boldTextBtn" title="Bold"><i class="fa-solid fa-bold"></i></button>
                        <button class="btn icon-btn text-control" id="italicTextBtn" title="Italic"><i class="fa-solid fa-italic"></i></button>
                        <button class="btn icon-btn text-control" id="underlineTextBtn" title="Underline"><i class="fa-solid fa-underline"></i></button>
                        <button class="btn icon-btn text-control" id="alignLeftBtn" title="Align Left"><i class="fa-solid fa-align-left"></i></button>
                        <button class="btn icon-btn text-control" id="alignCenterBtn" title="Align Center"><i class="fa-solid fa-align-center"></i></button>
                        <button class="btn icon-btn text-control" id="alignRightBtn" title="Align Right"><i class="fa-solid fa-align-right"></i></button>
                    </div>
                    <button class="btn secondary" id="clearTextFormattingBtn" style="margin-top:10px;"><i class="fa-solid fa-eraser"></i> Clear Formatting</button>
                </div>

                <div class="control-group">
                    <label for="textOpacity">Opacity: <span id="textOpacityValue">100%</span></label>
                    <input type="range" id="textOpacity" min="0" max="1" step="0.01" value="1">
                </div>
                </div>
        </div>
    </div>
    
    <div id="sidePanelContainer" class="side-panel-overlay">
        <div id="projectPanel" class="side-panel" data-panel-name="Project">
            <button class="close-side-panel-btn">&times;</button>
            <h3>Project</h3>
            <div class="side-panel-content">
                <div class="control-group">
                    <label>Canvas Actions:</label>
                    <div class="btn-group">
                        <button class="btn" id="newCanvasBtn_side"><i class="fa-solid fa-file"></i> New Blank Design</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>Undo/Redo:</label>
                    <div class="btn-group">
                        <button class="btn secondary icon-btn" id="undoBtn_side" title="Undo (Ctrl+Z)"><i class="fa-solid fa-rotate-left"></i></button>
                        <button class="btn secondary icon-btn" id="redoBtn_side" title="Redo (Ctrl+Y)"><i class="fa-solid fa-rotate-right"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="imagePanel" class="side-panel" data-panel-name="Image">
            <button class="close-side-panel-btn">&times;</button>
            <h3>Image</h3>
            <div class="side-panel-content">
                <div class="control-group">
                    <label>Background:</label>
                    <input type="file" id="uploadBackground_side" accept="image/*" style="display: none;">
                    <button class="btn custom-file-input-btn" id="triggerUploadBackground_side"><i class="fa-solid fa-cloud-arrow-up"></i> Select Background Image</button>
                    <p style="font-size:0.85rem; color: var(--tertiary-color); margin-top:5px;">(Canvas will resize to image)</p>
                </div>
                <div class="control-group">
                    <label>Add Image/Logo:</label>
                    <input type="file" id="uploadImage_side" accept="image/*" style="display: none;">
                    <button class="btn custom-file-input-btn" id="triggerUploadImage_side"><i class="fa-solid fa-image"></i> Add Image/Logo</button>
                </div>
            </div>
        </div>

        <div id="vectorPanel" class="side-panel" data-panel-name="Vector Graphics">
            <button class="close-side-panel-btn">&times;</button>
            <h3>Vector Graphics</h3>
            <div class="side-panel-content">
                <div class="control-group">
                    <label>Add Shape:</label>
                    <div class="btn-group">
                        <button class="btn secondary icon-btn" id="addRectBtn_side" title="Add Rectangle"><i class="fa-solid fa-square"></i></button>
                        <button class="btn secondary icon-btn" id="addCircleBtn_side" title="Add Circle"><i class="fa-solid fa-circle"></i></button>
                        <button class="btn secondary icon-btn" id="addTriangleBtn_side" title="Add Triangle"><i class="fa-solid fa-caret-up"></i></button>
                    </div>
                </div>
                <div class="control-group">
                    <label>SVG Library:</label>
                    <input type="file" id="uploadSvg_side" accept=".svg" multiple style="display: none;">
                    <button class="btn custom-file-input-btn" id="triggerUploadSvg_side"><i class="fa-solid fa-upload"></i> Upload SVG(s)</button>
                    <p style="font-size:0.85rem; color: var(--tertiary-color); margin-top:5px;">(Upload .svg files to library)</p>
                    <button class="btn secondary" id="loadSvgLibraryBtn_side" style="margin-top:10px;"><i class="fa-solid fa-folder-open"></i> Open Library</button>
                </div>
            </div>
        </div>

        <div id="objectPanel" class="side-panel" data-panel-name="Object">
            <button class="close-side-panel-btn">&times;</button>
            <h3>Object</h3>
            <div class="side-panel-content">
                <div class="control-group">
                    <label>Layer Order:</label>
                    <div class="btn-group" style="margin-top:0; justify-content: space-between;"> 
                        <button class="btn secondary icon-btn" id="bringForwardBtn_side" title="Bring Forward"><i class="fa-solid fa-arrow-up-from-line"></i></button>
                        <button class="btn secondary icon-btn" id="sendBackwardBtn_side" title="Send Backward"><i class="fa-solid fa-arrow-down-to-line"></i></button>
                    </div>
                </div>
                <div class="control-group">
                    <label>Remove Selected:</label>
                    <div class="btn-group">
                        <button class="btn danger icon-btn" id="deleteObjectBtn_side" title="Delete Selected"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="templatesPanel" class="side-panel" data-panel-name="Templates">
            <button class="close-side-panel-btn">&times;</button>
            <h3>Templates</h3>
            <div class="side-panel-content">
                <div class="control-group">
                    <label>Manage Templates:</label>
                    <div class="btn-group">
                        <button class="btn" id="saveTemplateBtn_side"><i class="fa-solid fa-star"></i> Save Current</button>
                        <button class="btn primary" id="openTemplateUploadInput_side"><i class="fa-solid fa-upload"></i> Upload</button>
                        <button class="btn secondary" id="openTemplatesLibraryBtn_side"><i class="fa-solid fa-folder-open"></i> Library</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>Share Templates:</label>
                    <div class="btn-group">
                        <button class="btn success" id="exportTemplateBtn_side"><i class="fa-solid fa-download"></i> Export (JSON)</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="exportPanel" class="side-panel" data-panel-name="Export">
            <button class="close-side-panel-btn">&times;</button>
            <h3>Export</h3>
            <div class="side-panel-content">
                <div class="control-group">
                    <label>Download Design:</label>
                    <div class="btn-group">
                        <button class="btn success" id="exportPngBtn_side"><i class="fa-solid fa-file-image"></i> PNG</button>
                        <button class="btn success" id="exportJpgBtn_side"><i class="fa-solid fa-image"></i> JPG</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="loadingOverlay" class="loading-overlay" style="display: none;"><div class="loader"></div><p>Processing...</p></div>
    <div id="notification-container"></div>

    <div id="loadProjectModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeLoadModal">&times;</button>
            <h2>Saved Projects (Legacy)</h2>
            <ul id="savedProjectsList" class="modal-list">
                </ul>
            <p id="noItemsMessage" class="no-items-message" style="display: none;">No projects saved yet.</p>
        </div>
    </div>

    <div id="svgLibraryModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeSvgLibraryModal">&times;</button>
            <h2>SVG Library</h2>
            <ul id="savedSvgList" class="modal-list">
                </ul>
            <p id="noSvgMessage" class="no-items-message" style="display: none;">No SVGs saved yet. Upload one to get started!</p>
        </div>
    </div>

    <div id="templatesLibraryModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeTemplatesLibraryModal">&times;</button>
            <h2>My Design Templates</h2>
            <ul id="localTemplatesList" class="modal-list">
                </ul>
            <p id="noLocalTemplatesMessage" class="no-items-message" style="display: none;">No templates saved yet. Design one and save it!</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = new fabric.Canvas('designCanvas', {
                backgroundColor: '#f0f0f0', 
                preserveObjectStacking: true 
            });

            const elements = {
                loadingOverlay: document.getElementById('loadingOverlay'),
                notificationContainer: document.getElementById('notification-container'),
                uploadBackground: document.getElementById('uploadBackground_side'),
                triggerUploadBackground: document.getElementById('triggerUploadBackground_side'), 
                uploadImage: document.getElementById('uploadImage_side'),
                triggerUploadImage: document.getElementById('triggerUploadImage_side'), 
                textInput: document.getElementById('textInput'),
                addTextBtn: document.getElementById('addTextBtn'),
                fontFamily: document.getElementById('fontFamily'),
                fontSize: document.getElementById('fontSize'),
                colorSwatches: document.querySelectorAll('.color-swatch'), 
                boldTextBtn: document.getElementById('boldTextBtn'), 
                italicTextBtn: document.getElementById('italicTextBtn'), 
                underlineTextBtn: document.getElementById('underlineTextBtn'), 
                alignLeftBtn: document.getElementById('alignLeftBtn'), 
                alignCenterBtn: document.getElementById('alignCenterBtn'), 
                alignRightBtn: document.getElementById('alignRightBtn'), 
                clearTextFormattingBtn: document.getElementById('clearTextFormattingBtn'), 
                textOpacity: document.getElementById('textOpacity'), 
                textOpacityValue: document.getElementById('textOpacityValue'), 

                bringForwardBtn: document.getElementById('bringForwardBtn_side'),
                sendBackwardBtn: document.getElementById('sendBackwardBtn_side'),
                deleteObjectBtn: document.getElementById('deleteObjectBtn_side'),
                
                exportPngBtn: document.getElementById('exportPngBtn_side'),
                exportJpgBtn: document.getElementById('exportJpgBtn_side'),
                loadProjectModal: document.getElementById('loadProjectModal'), 
                closeLoadModal: document.getElementById('closeLoadModal'),
                savedProjectsList: document.getElementById('savedProjectsList'),
                noItemsMessage: document.getElementById('noItemsMessage'),
                
                addRectBtn: document.getElementById('addRectBtn_side'),
                addCircleBtn: document.getElementById('addCircleBtn_side'),
                addTriangleBtn: document.getElementById('addTriangleBtn_side'),
                uploadSvg: document.getElementById('uploadSvg_side'), 
                triggerUploadSvg: document.getElementById('triggerUploadSvg_side'), 
                loadSvgLibraryBtn: document.getElementById('loadSvgLibraryBtn_side'),
                svgLibraryModal: document.getElementById('svgLibraryModal'),
                closeSvgLibraryModal: document.getElementById('closeSvgLibraryModal'),
                savedSvgList: document.getElementById('savedSvgList'),
                noSvgMessage: document.getElementById('noSvgMessage'),
                
                customColorPicker: document.getElementById('customColorPicker'),
                
                undoBtn: document.getElementById('undoBtn_side'),
                redoBtn: document.getElementById('redoBtn_side'),
                
                newCanvasBtn: document.getElementById('newCanvasBtn_side'), 
                saveTemplateBtn: document.getElementById('saveTemplateBtn_side'),
                exportTemplateBtn: document.getElementById('exportTemplateBtn_side'),
                openTemplateUploadInput: document.getElementById('openTemplateUploadInput_side'), 
                hiddenTemplateFileUpload: document.createElement('input'), // This is the dynamically created input
                openTemplatesLibraryBtn: document.getElementById('openTemplatesLibraryBtn_side'),
                templatesLibraryModal: document.getElementById('templatesLibraryModal'),
                closeTemplatesLibraryModal: document.getElementById('closeTemplatesLibraryModal'),
                localTemplatesList: document.getElementById('localTemplatesList'),
                noLocalTemplatesMessage: document.getElementById('noLocalTemplatesMessage'),

                sidePanelContainer: document.getElementById('sidePanelContainer'),
                menuButtons: document.querySelectorAll('.controls-panel-menu .menu-btn'),
                sidePanels: document.querySelectorAll('.side-panel'),
                closeSidePanelButtons: document.querySelectorAll('.close-side-panel-btn')
            };

            const LOCAL_STORAGE_PROJECTS_KEY = 'simpleDesignProjects'; 
            const LOCAL_STORAGE_SVGS_KEY = 'simpleDesignSVGLibrary';
            const LOCAL_STORAGE_TEMPLATES_KEY = 'simpleDesignUserTemplates'; 

            // Append the hidden file input to the body
            elements.hiddenTemplateFileUpload.type = 'file';
            elements.hiddenTemplateFileUpload.accept = '.json';
            elements.hiddenTemplateFileUpload.multiple = true; 
            // Apply strict hiding styles directly to the element to ensure it doesn't affect layout
            elements.hiddenTemplateFileUpload.style.position = 'absolute';
            elements.hiddenTemplateFileUpload.style.width = '1px';
            elements.hiddenTemplateFileUpload.style.height = '1px';
            elements.hiddenTemplateFileUpload.style.padding = '0';
            elements.hiddenTemplateFileUpload.style.margin = '-1px';
            elements.hiddenTemplateFileUpload.style.overflow = 'hidden';
            elements.hiddenTemplateFileUpload.style.clip = 'rect(0, 0, 0, 0)';
            elements.hiddenTemplateFileUpload.style.border = '0';
            elements.hiddenTemplateFileUpload.style.opacity = '0';
            elements.hiddenTemplateFileUpload.style.pointerEvents = 'none';
            elements.hiddenTemplateFileUpload.style.zIndex = '-1'; 
            document.body.appendChild(elements.hiddenTemplateFileUpload); 

            // --- Loading Indicators Helpers ---
            const originalIconClasses = {
                'triggerUploadBackground_side': 'fa-cloud-arrow-up',
                'triggerUploadImage_side': 'fa-image',
                'triggerUploadSvg_side': 'fa-upload',
                'addTextBtn': 'fa-plus',
                'saveTemplateBtn_side': 'fa-star',
                'openTemplateUploadInput_side': 'fa-upload',
                'openTemplatesLibraryBtn_side': 'fa-folder-open',
                'exportTemplateBtn_side': 'fa-download',
                'exportPngBtn_side': 'fa-file-image',
                'exportJpgBtn_side': 'fa-image',
                'loadSvgLibraryBtn_side': 'fa-folder-open',
                'newCanvasBtn_side': 'fa-file', 
                'undoBtn_side': 'fa-rotate-left',
                'redoBtn_side': 'fa-rotate-right',
                'addRectBtn_side': 'fa-square',
                'addCircleBtn_side': 'fa-circle',
                'addTriangleBtn_side': 'fa-caret-up',
                'bringForwardBtn_side': 'fa-arrow-up-from-line',
                'sendBackwardBtn_side': 'fa-arrow-down-to-line',
                'deleteObjectBtn_side': 'fa-trash'
            };

            function showLoading(buttonElement) {
                if (buttonElement) {
                    buttonElement.classList.add('loading');
                    const icon = buttonElement.querySelector('i');
                    if (icon) {
                        const originalClasses = Array.from(icon.classList).filter(cls => !cls.startsWith('fa-') || cls === 'fa-solid');
                        buttonElement.dataset.originalIcon = originalClasses.join(' ');
                        icon.classList.remove(...Array.from(icon.classList).filter(cls => cls.startsWith('fa-') && cls !== 'fa-solid')); 
                        icon.classList.add('fa-solid', 'fa-spinner', 'fa-spin');
                    }
                }
            }

            function hideLoading(buttonElement) {
                if (buttonElement) {
                    buttonElement.classList.remove('loading');
                    const icon = buttonElement.querySelector('i');
                    if (icon && buttonElement.dataset.originalIcon) {
                        icon.classList.remove(...Array.from(icon.classList).filter(cls => cls.startsWith('fa-') && cls !== 'fa-solid'));
                        icon.classList.add(...buttonElement.dataset.originalIcon.split(' ').filter(cls => cls !== 'fa-solid')); 
                        if (!icon.classList.contains('fa-solid')) icon.classList.add('fa-solid');
                        delete buttonElement.dataset.originalIcon; 
                    }
                }
            }


            // --- History Management (Undo/Redo) ---
            let canvasHistory = [];
            let historyPointer = -1;
            const MAX_HISTORY_STEPS = 50;

            function saveCanvasState() {
                const currentJson = JSON.stringify(canvas.toJSON());
                if (historyPointer >= 0 && JSON.stringify(canvasHistory[historyPointer]) === currentJson) {
                    return;
                }
                if (historyPointer < canvasHistory.length - 1) {
                    canvasHistory = canvasHistory.slice(0, historyPointer + 1);
                }
                canvasHistory.push(JSON.parse(currentJson));
                if (canvasHistory.length > MAX_HISTORY_STEPS) {
                    canvasHistory.shift();
                } else {
                    historyPointer++;
                }
            }

            function undoCanvas() {
                if (historyPointer > 0) {
                    historyPointer--;
                    canvas.loadFromJSON(canvasHistory[historyPointer], () => {
                        canvas.renderAll();
                        showNotification('info', 'Undo', 'Last action undone.');
                    });
                } else {
                    showNotification('warning', 'Undo Limit', 'Nothing more to undo.');
                }
            }

            function redoCanvas() {
                if (historyPointer < canvasHistory.length - 1) {
                    historyPointer++;
                    canvas.loadFromJSON(canvasHistory[historyPointer], () => {
                        canvas.renderAll();
                        showNotification('info', 'Redo', 'Action redone.');
                    });
                } else {
                    showNotification('warning', 'Redo Limit', 'Nothing more to redo.');
                }
            }

            canvas.on('object:added', saveCanvasState);
            canvas.on('object:modified', saveCanvasState);
            canvas.on('object:removed', saveCanvasState);
            canvas.on('object:skewed', saveCanvasState);
            canvas.on('text:changed', saveCanvasState);
            canvas.on('text:editing:exited', saveCanvasState);
            canvas.on('after:render', () => {
                if (historyPointer === -1) {
                    saveCanvasState();
                }
            });

            // --- Notification System ---
            function showNotification(type = 'success', title, message) {
                const toast = document.createElement('div');
                toast.classList.add('toast', type);
                const icons = { success: 'fa-check-circle', error: 'fa-times-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
                toast.innerHTML = `
                    <i class="fa-solid ${icons[type]}"></i>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="close-btn">&times;</button>`;
                elements.notificationContainer.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 100);
                const hideTimeout = setTimeout(() => {
                    toast.classList.add('hide');
                    setTimeout(() => toast.remove(), 400);
                }, 5000);
                toast.querySelector('.close-btn').addEventListener('click', () => {
                    clearTimeout(hideTimeout);
                    toast.classList.add('hide');
                    setTimeout(() => toast.remove(), 400);
                });
            }

            // --- Canvas Initialization and Resizing ---
            function setCanvasBackgroundAndSize(imageObject = null) {
                const designArea = document.querySelector('.design-area');
                let targetWidth = 400;
                let targetHeight = 400;

                if (imageObject) {
                    const maxWidth = designArea.clientWidth - 40; 
                    const maxHeight = designArea.clientHeight - 40;
                    
                    const scale = Math.min(maxWidth / imageObject.width, maxHeight / imageObject.height);
                    targetWidth = imageObject.width * scale;
                    targetHeight = imageObject.height * scale;

                    canvas.setBackgroundImage(imageObject, canvas.renderAll.bind(canvas), {
                        scaleX: scale,
                        scaleY: scale,
                        originX: 'left',
                        originY: 'top',
                        left: 0,
                        top: 0
                    });
                } else {
                    canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas)); 
                }

                canvas.setWidth(targetWidth);
                canvas.setHeight(targetHeight);
                canvas.renderAll();
                canvas.requestRenderAll(); 
            }

            // --- New Blank Canvas ---
            elements.newCanvasBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to start a new blank design? Any unsaved changes will be lost.')) {
                    canvas.clear();
                    setCanvasBackgroundAndSize(null); 
                    canvas.backgroundColor = '#f0f0f0'; 
                    canvas.renderAll();
                    showNotification('info', 'New Design', 'New blank canvas created.');
                    saveCanvasState(); 
                    hideSidePanel(); 
                }
            });

            // --- Trigger file inputs from custom buttons ---
            elements.triggerUploadBackground.addEventListener('click', () => elements.uploadBackground.click());
            elements.triggerUploadImage.addEventListener('click', () => elements.uploadImage.click());
            elements.triggerUploadSvg.addEventListener('click', () => elements.uploadSvg.click());


            // --- Upload Background Image ---
            elements.uploadBackground.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    showLoading(elements.triggerUploadBackground); 
                    const reader = new FileReader();
                    reader.onload = (f) => {
                        const data = f.target.result;
                        fabric.Image.fromURL(data, (img) => {
                            hideLoading(elements.triggerUploadBackground); 
                            if (!img) {
                                showNotification('error', 'Image Load Error', 'Could not load background image. Ensure it\'s a valid image file.');
                                return;
                            }
                            canvas.clear(); 
                            setCanvasBackgroundAndSize(img);
                            showNotification('success', 'Background Updated', 'Background image loaded successfully.');
                            saveCanvasState(); 
                        }, { crossOrigin: 'anonymous' }); 
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = ''; 
            });

            // --- Add Image/Logo ---
            elements.uploadImage.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    showLoading(elements.triggerUploadImage); 
                    const reader = new FileReader();
                    reader.onload = (f) => {
                        const data = f.target.result;
                        fabric.Image.fromURL(data, (img) => {
                            hideLoading(elements.triggerUploadImage); 
                            if (!img) {
                                showNotification('error', 'Image Load Error', 'Could not load image/logo. Ensure it\'s a valid image file.');
                                return;
                            }
                            if (img.width > canvas.getWidth() || img.height > canvas.getHeight()) {
                                img.scaleToWidth(canvas.getWidth() / 4); 
                                if (img.getScaledHeight() > canvas.getHeight()) { 
                                    img.scaleToHeight(canvas.getHeight() / 4);
                                }
                            }
                            
                            img.set({
                                left: canvas.getWidth() / 2 - img.getScaledWidth() / 2,
                                top: canvas.getHeight() / 2 - img.getScaledHeight() / 2,
                                originX: 'left',
                                originY: 'top'
                            });
                            canvas.add(img);
                            canvas.setActiveObject(img);
                            canvas.renderAll();
                            showNotification('success', 'Image Added', 'Image/logo added to canvas.');
                            hideSidePanel(); 
                            saveCanvasState(); 
                        }, { crossOrigin: 'anonymous' }); 
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = ''; 
            });

            // --- Add Text ---
            elements.addTextBtn.addEventListener('click', () => {
                const text = elements.textInput.value.trim();
                if (text) {
                    showLoading(elements.addTextBtn); 
                    const textObject = new fabric.IText(text, {
                        left: 50,
                        top: 50,
                        fontFamily: elements.fontFamily.value,
                        fontSize: parseInt(elements.fontSize.value),
                        fill: elements.customColorPicker.value,
                        fontWeight: elements.boldTextBtn.classList.contains('active') ? 'bold' : 'normal',
                        fontStyle: elements.italicTextBtn.classList.contains('active') ? 'italic' : 'normal',
                        underline: elements.underlineTextBtn.classList.contains('active') ? true : false, 
                        textAlign: 'left', 
                        opacity: parseFloat(elements.textOpacity.value), 
                        stroke: null, 
                        strokeWidth: 0 
                    });
                    canvas.add(textObject);
                    canvas.setActiveObject(textObject);
                    canvas.renderAll();
                    elements.textInput.value = ''; 
                    showNotification('success', 'Text Added', 'Text added to canvas.');
                    hideLoading(elements.addTextBtn); 
                    saveCanvasState(); 
                } else {
                    showNotification('warning', 'Input Empty', 'Please enter some text to add.');
                }
            });

            // --- Text Style Controls ---
            function applyTextStyle(prop, value) {
                const activeObject = canvas.getActiveObject();
                if (activeObject && (activeObject.type === 'i-text' || activeObject.type === 'text')) {
                    activeObject.set(prop, value);
                    canvas.renderAll();
                    saveCanvasState(); 
                } else {
                    showNotification('warning', 'No Text Selected', 'Please select a text object to apply changes.');
                }
            }
            function applyColorToActiveObject(color) {
                const activeObject = canvas.getActiveObject();
                if (activeObject) {
                    if (activeObject.type === 'i-text' || activeObject.type === 'text') {
                        activeObject.set('fill', color);
                    } else if (activeObject.type === 'rect' || activeObject.type === 'circle' || activeObject.type === 'triangle') {
                        activeObject.set('fill', color);
                    } else if (activeObject.type === 'group' && activeObject.paths) { 
                         activeObject.paths.forEach(path => {
                            if (path.fill && path.fill !== 'none') { 
                                path.set('fill', color);
                            }
                        });
                        canvas.renderAll(); 
                    }
                    canvas.renderAll();
                    saveCanvasState(); 
                } else {
                    showNotification('warning', 'No Object Selected', 'Please select an object to change its color.');
                }
            }

            elements.fontFamily.addEventListener('change', (e) => applyTextStyle('fontFamily', e.target.value));
            elements.fontSize.addEventListener('input', (e) => applyTextStyle('fontSize', parseInt(e.target.value)));
            
            elements.customColorPicker.addEventListener('input', (e) => {
                const newColor = e.target.value;
                elements.colorSwatches.forEach(s => s.classList.remove('active'));
                applyColorToActiveObject(newColor);
            });

            elements.colorSwatches.forEach(swatch => {
                swatch.addEventListener('click', () => {
                    elements.colorSwatches.forEach(s => s.classList.remove('active')); 
                    swatch.classList.add('active'); 
                    const selectedColor = swatch.dataset.color;
                    elements.customColorPicker.value = selectedColor; 
                    applyColorToActiveObject(selectedColor);
                });
            });

            elements.boldTextBtn.addEventListener('click', (e) => {
                e.target.classList.toggle('active');
                applyTextStyle('fontWeight', e.target.classList.contains('active') ? 'bold' : 'normal');
            });

            elements.italicTextBtn.addEventListener('click', (e) => {
                e.target.classList.toggle('active');
                applyTextStyle('fontStyle', e.target.classList.contains('active') ? 'italic' : 'normal');
            });

            elements.underlineTextBtn.addEventListener('click', (e) => {
                e.target.classList.toggle('active');
                applyTextStyle('underline', e.target.classList.contains('active') ? true : false);
            });

            // Text Alignment Controls
            function toggleAlignmentButtonActiveState(clickedButton) {
                [elements.alignLeftBtn, elements.alignCenterBtn, elements.alignRightBtn].forEach(btn => {
                    btn.classList.remove('active');
                });
                clickedButton.classList.add('active');
            }

            elements.alignLeftBtn.addEventListener('click', () => {
                toggleAlignmentButtonActiveState(elements.alignLeftBtn);
                applyTextStyle('textAlign', 'left');
            });
            elements.alignCenterBtn.addEventListener('click', () => {
                toggleAlignmentButtonActiveState(elements.alignCenterBtn);
                applyTextStyle('textAlign', 'center');
            });
            elements.alignRightBtn.addEventListener('click', () => {
                toggleAlignmentButtonActiveState(elements.alignRightBtn);
                applyTextStyle('textAlign', 'right');
            });

            elements.clearTextFormattingBtn.addEventListener('click', () => {
                const activeObject = canvas.getActiveObject();
                if (activeObject && (activeObject.type === 'i-text' || activeObject.type === 'text')) {
                    activeObject.set({
                        fontFamily: 'Cairo',
                        fontSize: 30,
                        fill: '#1a1a1a',
                        fontWeight: 'normal',
                        fontStyle: 'normal',
                        underline: false,
                        textAlign: 'left',
                        opacity: 1,
                        stroke: null, 
                        strokeWidth: 0 
                    });
                    canvas.renderAll();
                    updateControlsForActiveObject(); 
                    showNotification('info', 'Formatting Cleared', 'Text formatting has been reset.');
                    saveCanvasState();
                } else {
                    showNotification('warning', 'No Text Selected', 'Please select a text object to clear its formatting.');
                }
            });

            elements.textOpacity.addEventListener('input', (e) => {
                const opacityValue = parseFloat(e.target.value);
                elements.textOpacityValue.textContent = `${Math.round(opacityValue * 100)}%`;
                const activeObject = canvas.getActiveObject();
                if (activeObject) { 
                    activeObject.set('opacity', opacityValue);
                    canvas.renderAll();
                    saveCanvasState();
                }
            });

            // --- Object Controls (Bring Forward, Send Backward, Delete) ---
            elements.bringForwardBtn.addEventListener('click', () => {
                const activeObject = canvas.getActiveObject();
                if (activeObject) {
                    canvas.bringForward(activeObject);
                    canvas.renderAll();
                    showNotification('info', 'Layer Order', 'Object moved forward.');
                    saveCanvasState(); 
                } else {
                    showNotification('warning', 'No Object Selected', 'Please select an object to move.');
                }
            });

            elements.sendBackwardBtn.addEventListener('click', () => {
                const activeObject = canvas.getActiveObject();
                if (activeObject) {
                    canvas.sendBackward(activeObject);
                    canvas.renderAll();
                    showNotification('info', 'Layer Order', 'Object moved backward.');
                    saveCanvasState(); 
                } else {
                    showNotification('warning', 'No Object Selected', 'Please select an object to move.');
                }
            });

            elements.deleteObjectBtn.addEventListener('click', () => {
                const activeObjects = canvas.getActiveObjects();
                if (activeObjects && activeObjects.length > 0) {
                    activeObjects.forEach(obj => canvas.remove(obj));
                    canvas.discardActiveObject(); 
                    canvas.renderAll();
                    showNotification('success', 'Objects Deleted', `${activeObjects.length} selected object(s) removed.`);
                    saveCanvasState(); 
                } else {
                    showNotification('warning', 'No Object Selected', 'Please select an object to delete.');
                }
            });

            // --- Export to PNG/JPG ---
            function exportCanvas(format) {
                if (canvas.getObjects().length === 0 && !canvas.backgroundImage) { 
                    showNotification('warning', 'Empty Canvas', 'Add some content before exporting.');
                    return;
                }
                
                const exportButton = format === 'png' ? elements.exportPngBtn : elements.exportJpgBtn;
                showLoading(exportButton); 

                try {
                    const exportQuality = 0.9; 
                    const dataURL = canvas.toDataURL({
                        format: format,
                        quality: exportQuality, 
                        multiplier: 1 
                    });
                    const link = document.createElement('a');
                    link.href = dataURL;
                    link.download = `design_project_${Date.now()}.${format}`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showNotification('success', 'Export Success', `Design exported as ${format.toUpperCase()}.`);
                } catch (error) {
                    console.error('Export error:', error);
                    showNotification('error', 'Export Failed', 'Could not export design. Try again or check browser console.');
                } finally {
                    hideLoading(exportButton); 
                    hideSidePanel(); 
                }
            }

            elements.exportPngBtn.addEventListener('click', () => exportCanvas('png'));
            elements.exportJpgBtn.addEventListener('click', () => exportCanvas('jpeg'));

            // --- Add Vector Shapes ---
            elements.addRectBtn.addEventListener('click', () => {
                const rect = new fabric.Rect({
                    left: 100,
                    top: 100,
                    fill: elements.customColorPicker.value,
                    width: 100,
                    height: 100,
                    selectable: true,
                    hasControls: true
                });
                canvas.add(rect);
                canvas.setActiveObject(rect);
                canvas.renderAll();
                showNotification('success', 'Shape Added', 'Rectangle added to canvas.');
                saveCanvasState(); 
                hideSidePanel(); 
            });

            elements.addCircleBtn.addEventListener('click', () => {
                const circle = new fabric.Circle({
                    left: 100,
                    top: 100,
                    fill: elements.customColorPicker.value,
                    radius: 50,
                    selectable: true,
                    hasControls: true
                });
                canvas.add(circle);
                canvas.setActiveObject(circle);
                canvas.renderAll();
                showNotification('success', 'Shape Added', 'Circle added to canvas.');
                saveCanvasState(); 
                hideSidePanel(); 
            });

            elements.addTriangleBtn.addEventListener('click', () => {
                const triangle = new fabric.Triangle({
                    left: 100,
                    top: 100,
                    fill: elements.customColorPicker.value,
                    width: 100,
                    height: 100,
                    selectable: true,
                    hasControls: true
                });
                canvas.add(triangle);
                canvas.setActiveObject(triangle);
                canvas.renderAll();
                showNotification('success', 'Shape Added', 'Triangle added to canvas.');
                saveCanvasState(); 
                hideSidePanel(); 
            });

            // --- Upload SVG (now supports multiple files) ---
            elements.uploadSvg.addEventListener('change', (e) => {
                const files = e.target.files;
                if (files.length === 0) {
                    e.target.value = ''; 
                    return;
                }

                let filesProcessed = 0;
                let filesAddedCount = 0;

                showLoading(elements.triggerUploadSvg); 

                const processFile = (file) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (f) => {
                            const svgData = f.target.result;
                            const originalFileName = file.name.split('.').slice(0, -1).join('.'); 
                            let svgName = originalFileName;
                            
                            let existingSVGs = JSON.parse(localStorage.getItem(LOCAL_STORAGE_SVGS_KEY) || '[]');
                            let counter = 1;
                            while (existingSVGs.some(s => s.name === svgName)) {
                                svgName = `${originalFileName}_${counter}`;
                                counter++;
                            }

                            fabric.loadSVGFromString(svgData, (objects, options) => {
                                const obj = fabric.util.groupSVGElements(objects, options);
                                
                                if (!obj) {
                                    showNotification('error', 'SVG Load Error', `Could not parse SVG file: ${file.name}. Ensure it is a valid SVG.`);
                                    resolve(); 
                                    return;
                                }

                                const tempCanvas = new fabric.StaticCanvas(null, { width: 100, height: 100, backgroundColor: '#f0f0f0' });
                                obj.clone(clonedObj => {
                                    if (clonedObj.type === 'group' && clonedObj.paths) {
                                        clonedObj.paths.forEach(path => {
                                            if (!path.fill || path.fill === 'none') { path.set('fill', '#cccccc'); }
                                        });
                                    } else if (!clonedObj.fill || clonedObj.fill === 'none') {
                                        clonedObj.set('fill', '#cccccc');
                                    }
                                    clonedObj.set({
                                        left: tempCanvas.getWidth() / 2, top: tempCanvas.getHeight() / 2,
                                        originX: 'center', originY: 'center',
                                        scaleX: Math.min(tempCanvas.getWidth() / (clonedObj.width || 1), tempCanvas.getHeight() / (clonedObj.height || 1)) * 0.8,
                                        scaleY: Math.min(tempCanvas.getWidth() / (clonedObj.width || 1), tempCanvas.getHeight() / (clonedObj.height || 1)) * 0.8,
                                    });
                                    tempCanvas.add(clonedObj);
                                    tempCanvas.renderAll();
                                    const thumbnailDataUrl = tempCanvas.toDataURL({ format: 'png', quality: 0.5 });
                                    tempCanvas.dispose();

                                    existingSVGs = JSON.parse(localStorage.getItem(LOCAL_STORAGE_SVGS_KEY) || '[]');
                                    existingSVGs.push({ name: svgName, timestamp: new Date().toISOString(), data: svgData, thumbnail: thumbnailDataUrl });
                                    localStorage.setItem(LOCAL_STORAGE_SVGS_KEY, JSON.stringify(existingSVGs));
                                    filesAddedCount++;
                                    resolve();
                                });
                            });
                        };
                        reader.readAsText(file);
                    });
                };

                const filePromises = Array.from(files).map(processFile);

                Promise.all(filePromises).then(() => {
                    hideLoading(elements.triggerUploadSvg); 
                    showNotification('success', 'SVG Uploaded', `${filesAddedCount} SVG(s) added to library.`);
                    e.target.value = ''; 
                    renderSvgLibrary(); 
                });
            });

            // --- SVG Library Functions (Display as grid, click to add, X to delete) ---
            function renderSvgLibrary() {
                const savedSVGs = JSON.parse(localStorage.getItem(LOCAL_STORAGE_SVGS_KEY) || '[]');
                elements.savedSvgList.innerHTML = '';

                if (savedSVGs.length === 0) {
                    elements.noSvgMessage.style.display = 'block';
                } else {
                    elements.noSvgMessage.style.display = 'none';
                    savedSVGs.forEach((svgItem, index) => {
                        const listItem = document.createElement('li');
                        listItem.classList.add('modal-list-item');
                        const thumbnailSrc = svgItem.thumbnail || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4YcAAAAhUlEQVR4Xu3OAQ0AAAEAoIL1b3qWwQJdAAAAAAAAAAAAAAAAAAAxB/h2AAH4NtsNAAAAAElFTkSuQmCC'; 
                        
                        listItem.innerHTML = `
                            <div class="modal-item-thumbnail">
                                <img src="${thumbnailSrc}" alt="${svgItem.name}">
                            </div>
                            <strong>${svgItem.name}</strong> 
                            <div class="modal-item-actions">
                                <button class="modal-btn danger"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                        `;
                        listItem.dataset.index = index; 

                        listItem.addEventListener('click', (e) => {
                            if (e.target.closest('.modal-btn.danger')) return; 

                            showLoading(elements.loadSvgLibraryBtn); 
                            const clickedIndex = listItem.dataset.index;
                            const svgData = savedSVGs[clickedIndex].data;

                            fabric.loadSVGFromString(svgData, (objects, options) => {
                                
                                const obj = fabric.util.groupSVGElements(objects, options);
                                
                                if (!obj) {
                                    showNotification('error', 'SVG Load Error', 'Could not parse SVG data from library.');
                                    hideLoading(elements.loadSvgLibraryBtn); 
                                    return;
                                }

                                const canvasCenter = { x: canvas.getWidth() / 2, y: canvas.getHeight() / 2 };
                                let scaleFactor = 1;
                                const maxCanvasDimension = Math.max(canvas.getWidth(), canvas.getHeight());
                                const maxSvgDimension = Math.max(obj.width || 1, obj.height || 1);

                                if (maxSvgDimension > maxCanvasDimension * 0.8) {
                                    scaleFactor = (maxCanvasDimension * 0.8) / maxSvgDimension;
                                }
                                
                                obj.set({
                                    left: canvasCenter.x - (obj.width * scaleFactor) / 2,
                                    top: canvasCenter.y - (obj.height * scaleFactor) / 2,
                                    scaleX: scaleFactor,
                                    scaleY: scaleFactor,
                                    originX: 'left', 
                                    originY: 'top',
                                    fill: obj.fill || elements.customColorPicker.value 
                                });

                                canvas.add(obj);
                                canvas.setActiveObject(obj);
                                canvas.renderAll();
                                showNotification('success', 'SVG Added', `SVG "${svgItem.name}" added from library.`);
                                elements.svgLibraryModal.classList.remove('show'); 
                                hideLoading(elements.loadSvgLibraryBtn); 
                                hideSidePanel(); 
                                saveCanvasState(); 
                            });
                        });

                        listItem.querySelector('.modal-btn.danger').addEventListener('click', (e) => {
                            e.stopPropagation(); 
                            const deleteIndex = listItem.dataset.index;
                            if (confirm(`Are you sure you want to delete SVG "${savedSVGs[deleteIndex].name}"?`)) {
                                savedSVGs.splice(deleteIndex, 1);
                                localStorage.setItem(LOCAL_STORAGE_SVGS_KEY, JSON.stringify(savedSVGs));
                                showNotification('success', 'SVG Deleted', 'SVG deleted from library.');
                                renderSvgLibrary(); 
                            }
                        });

                        elements.savedSvgList.appendChild(listItem);
                    });
                }
            }

            elements.loadSvgLibraryBtn.addEventListener('click', () => {
                renderSvgLibrary(); 
                elements.svgLibraryModal.classList.add('show');
            });

            elements.closeSvgLibraryModal.addEventListener('click', () => {
                elements.svgLibraryModal.classList.remove('show');
            });

            elements.svgLibraryModal.addEventListener('click', (e) => {
                if (e.target === elements.svgLibraryModal) {
                    elements.svgLibraryModal.classList.remove('show');
                }
            });

            // --- Templates Functions (User-defined Templates in Local Storage + Export/Import JSON files) ---
            
            // Event listener for "Save Current as Template" button
            elements.saveTemplateBtn.addEventListener('click', () => {
                if (canvas.getObjects().length === 0 && !canvas.backgroundImage) {
                    showNotification('warning', 'Empty Canvas', 'Add some content before saving as template.');
                    return;
                }

                const templateName = prompt('Enter a name for this template:');
                if (templateName) {
                    showLoading(elements.saveTemplateBtn); 
                    try {
                        const templateJson = canvas.toJSON();
                        
                        const tempCanvas = new fabric.StaticCanvas(null, {
                            width: 100, height: 100, backgroundColor: canvas.backgroundColor
                        });

                        if (canvas.backgroundImage) {
                            fabric.Image.fromURL(canvas.backgroundImage.getSrc(), (img) => {
                                tempCanvas.setBackgroundImage(img, tempCanvas.renderAll.bind(tempCanvas), {
                                    scaleX: tempCanvas.getWidth() / img.width,
                                    scaleY: tempCanvas.getHeight() / img.height,
                                    originX: 'left', top: 0, left: 0
                                });
                                addObjectsToThumbnailCanvas();
                            });
                        } else {
                            tempCanvas.backgroundColor = '#f0f0f0';
                            addObjectsToThumbnailCanvas();
                        }

                        function addObjectsToThumbnailCanvas() {
                            let objectsLoaded = 0;
                            const totalObjects = canvas.getObjects().length;

                            if (totalObjects === 0) {
                                generateThumbnailAndSave();
                                return;
                            }

                            canvas.getObjects().forEach(obj => {
                                obj.clone(clonedObj => {
                                    const aspectRatio = (clonedObj.width * clonedObj.scaleX) / (clonedObj.height * clonedObj.scaleY);
                                    let newWidth, newHeight;
                                    const padding = 10;
                                    const maxThumbWidth = tempCanvas.getWidth() - padding * 2;
                                    const maxThumbHeight = tempCanvas.getHeight() - padding * 2;

                                    if ((clonedObj.width * clonedObj.scaleX) > (clonedObj.height * clonedObj.scaleY)) {
                                        newWidth = maxThumbWidth; newHeight = maxThumbWidth / aspectRatio;
                                    } else {
                                        newHeight = maxThumbHeight; newWidth = maxThumbHeight * aspectRatio;
                                    }
                                    if (newWidth > maxThumbWidth) { newWidth = maxThumbWidth; newHeight = newWidth / aspectRatio; }
                                    if (newHeight > maxThumbHeight) { newHeight = maxThumbHeight; newWidth = newHeight / aspectRatio; }
                                    
                                    if (clonedObj.type === 'group' && clonedObj.paths) { 
                                        clonedObj.paths.forEach(path => {
                                            if (!path.fill || path.fill === 'none') { path.set('fill', '#cccccc'); }
                                        });
                                    } else if (!clonedObj.fill || clonedObj.fill === 'none') { 
                                        clonedObj.set('fill', '#cccccc');
                                    }


                                    clonedObj.set({
                                        left: tempCanvas.getWidth() / 2, top: tempCanvas.getHeight() / 2,
                                        originX: 'center', originY: 'center',
                                        scaleX: newWidth / (clonedObj.width || 1), scaleY: newHeight / (clonedObj.height || 1),
                                    });
                                    tempCanvas.add(clonedObj);
                                    objectsLoaded++;
                                    if (objectsLoaded === totalObjects) {
                                        generateThumbnailAndSave();
                                    }
                                });
                            });
                        }

                        function generateThumbnailAndSave() {
                            tempCanvas.renderAll();
                            const thumbnailDataUrl = tempCanvas.toDataURL({ format: 'png', quality: 0.7 });
                            tempCanvas.dispose(); 

                            let savedTemplates = JSON.parse(localStorage.getItem(LOCAL_STORAGE_TEMPLATES_KEY) || '[]');
                            const existingIndex = savedTemplates.findIndex(t => t.name === templateName);
                            if (existingIndex > -1) {
                                if (confirm(`Template "${templateName}" already exists. Overwrite?`)) {
                                    savedTemplates[existingIndex] = { name: templateName, timestamp: new Date().toISOString(), data: JSON.stringify(templateJson), thumbnail: thumbnailDataUrl };
                                    localStorage.setItem(LOCAL_STORAGE_TEMPLATES_KEY, JSON.stringify(savedTemplates));
                                    showNotification('success', 'Template Saved', `Template "${templateName}" overwritten.`);
                                } else {
                                    showNotification('info', 'Save Cancelled', 'Template not saved.');
                                }
                            } else {
                                savedTemplates.push({ name: templateName, timestamp: new Date().toISOString(), data: JSON.stringify(templateJson), thumbnail: thumbnailDataUrl });
                                localStorage.setItem(LOCAL_STORAGE_TEMPLATES_KEY, JSON.stringify(savedTemplates));
                                showNotification('success', 'Template Saved', `Template "${templateName}" saved successfully.`);
                            }
                            hideLoading(elements.saveTemplateBtn); 
                            hideSidePanel(); 
                        }
                    } catch (error) {
                        console.error('Error saving template:', error);
                        showNotification('error', 'Save Error', 'Could not save template. Storage might be full or data too large. Check console for details.');
                        hideLoading(elements.saveTemplateBtn); 
                    }
                } else {
                    showNotification('info', 'Save Cancelled', 'Template not saved.');
                }
            });

            function renderLocalTemplatesList() {
                const savedTemplates = JSON.parse(localStorage.getItem(LOCAL_STORAGE_TEMPLATES_KEY) || '[]');
                elements.localTemplatesList.innerHTML = '';

                if (savedTemplates.length === 0) {
                    elements.noLocalTemplatesMessage.style.display = 'block';
                } else {
                    elements.noLocalTemplatesMessage.style.display = 'none';
                    savedTemplates.forEach((template, index) => {
                        const listItem = document.createElement('li');
                        listItem.classList.add('modal-list-item');
                        const thumbnailSrc = template.thumbnail || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4YcAAAAhUlEQVR4Xu3OAQ0AAAEAoIL1b3qWwQJdAAAAAAAAAAAAAAAAAAAxB/h2AAH4NtsNAAAAAElFTkSuQmCC'; 
                        
                        listItem.innerHTML = `
                            <div class="modal-item-thumbnail">
                                <img src="${thumbnailSrc}" alt="${template.name}">
                            </div>
                            <strong>${template.name}</strong> 
                            <div class="modal-item-actions">
                                <button class="modal-btn danger"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                        `;
                        listItem.dataset.index = index; 

                        listItem.addEventListener('click', (e) => {
                            if (e.target.closest('.modal-btn.danger')) return; 

                            showLoading(elements.openTemplatesLibraryBtn); 
                            elements.templatesLibraryModal.classList.remove('show'); 
                            
                            const clickedIndex = listItem.dataset.index;
                            const templateData = savedTemplates[clickedIndex].data; 

                            canvas.clear();
                            canvas.loadFromJSON(templateData, () => {
                                if (canvas.backgroundImage) {
                                    fabric.Image.fromURL(canvas.backgroundImage.getSrc(), (img) => {
                                        setCanvasBackgroundAndSize(img);
                                        canvas.renderAll();
                                        hideLoading(elements.openTemplatesLibraryBtn); 
                                        showNotification('success', 'Template Loaded', `Template "${savedTemplates[clickedIndex].name}" loaded successfully.`);
                                        saveCanvasState();
                                        hideSidePanel(); 
                                    });
                                } else {
                                    setCanvasBackgroundAndSize(null); 
                                    canvas.renderAll();
                                    hideLoading(elements.openTemplatesLibraryBtn); 
                                    showNotification('success', 'Template Loaded', `Template "${savedTemplates[clickedIndex].name}" loaded successfully.`);
                                    saveCanvasState();
                                    hideSidePanel(); 
                                }
                            });
                        });

                        listItem.querySelector('.modal-btn.danger').addEventListener('click', (e) => {
                            e.stopPropagation(); 
                            const deleteIndex = listItem.dataset.index;
                            if (confirm(`Are you sure you want to delete template "${savedTemplates[deleteIndex].name}"?`)) {
                                savedTemplates.splice(deleteIndex, 1);
                                localStorage.setItem(LOCAL_STORAGE_TEMPLATES_KEY, JSON.stringify(savedTemplates));
                                showNotification('success', 'Template Deleted', 'Template deleted from library.');
                                renderLocalTemplatesList(); 
                            }
                        });

                        elements.localTemplatesList.appendChild(listItem);
                    });
                }
            }

            elements.openTemplatesLibraryBtn.addEventListener('click', () => {
                renderLocalTemplatesList(); 
                elements.templatesLibraryModal.classList.add('show');
            });

            elements.closeTemplatesLibraryModal.addEventListener('click', () => {
                elements.templatesLibraryModal.classList.remove('show');
            });

            elements.templatesLibraryModal.addEventListener('click', (e) => {
                if (e.target === elements.templatesLibraryModal) {
                    elements.templatesLibraryModal.classList.remove('show');
                }
            });

            // --- Export Current Template (JSON) ---
            elements.exportTemplateBtn.addEventListener('click', () => {
                if (canvas.getObjects().length === 0 && !canvas.backgroundImage) {
                    showNotification('warning', 'Empty Canvas', 'Add some content before exporting as template.');
                    return;
                }

                showLoading(elements.exportTemplateBtn); 
                try {
                    const templateJson = JSON.stringify(canvas.toJSON(), null, 2);
                    const blob = new Blob([templateJson], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `template_design_${Date.now()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showNotification('success', 'Template Exported', 'Current design exported as JSON template.');
                } catch(error) {
                    console.error('Error exporting template:', error);
                    showNotification('error', 'Export Failed', 'Could not export template. Check console for details.');
                } finally {
                    hideLoading(elements.exportTemplateBtn); 
                    hideSidePanel(); 
                }
            });

            // --- Upload Template (into local library) ---
            elements.openTemplateUploadInput.addEventListener('click', () => {
                elements.hiddenTemplateFileUpload.click();
            });

            elements.hiddenTemplateFileUpload.addEventListener('change', (e) => {
                const files = e.target.files;
                if (files.length === 0) {
                    e.target.value = ''; 
                    return;
                }

                let processedCount = 0;
                let successfulUploads = 0;

                showLoading(elements.openTemplateUploadInput); 
                
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (f) => {
                        try {
                            const templateData = JSON.parse(f.target.result);

                            if (!templateData || !templateData.version || !Array.isArray(templateData.objects)) {
                                throw new Error('Invalid Fabric.js template structure.');
                            }

                            const originalFileName = file.name.split('.').slice(0, -1).join('.');
                            let templateName = originalFileName;

                            let savedTemplates = JSON.parse(localStorage.getItem(LOCAL_STORAGE_TEMPLATES_KEY) || '[]');
                            let counter = 1;
                            while (savedTemplates.some(t => t.name === templateName)) {
                                templateName = `${originalFileName}_${counter}`;
                                counter++;
                            }

                            const tempCanvas = new fabric.StaticCanvas(null, {
                                width: 100, 
                                height: 100, 
                                backgroundColor: templateData.backgroundImage ? templateData.backgroundImage.backgroundColor || '#f0f0f0' : '#f0f0f0'
                            });

                            tempCanvas.loadFromJSON(templateData, () => {
                                tempCanvas.setZoom(1); 
                                let scaleFactor = 1;
                                const allObjects = tempCanvas.getObjects();
                                if (allObjects.length > 0) {
                                    const tempGroup = new fabric.Group(allObjects); 
                                    tempCanvas.remove(...allObjects); 
                                    
                                    const objectsBounds = tempGroup.getBoundingRect(); 

                                    const thumbPadding = 10;
                                    const maxThumbWidth = tempCanvas.getWidth() - thumbPadding * 2;
                                    const maxThumbHeight = tempCanvas.getHeight() - thumbPadding * 2;
                                    const objectsMaxDimension = Math.max(objectsBounds.width, objectsBounds.height);

                                    if (objectsMaxDimension > 0 && objectsMaxDimension > Math.min(maxThumbWidth, maxThumbHeight)) {
                                        scaleFactor = Math.min(maxThumbWidth, maxThumbHeight) / objectsMaxDimension;
                                    }
                                    
                                    tempGroup.set({ 
                                        scaleX: scaleFactor, 
                                        scaleY: scaleFactor,
                                        left: tempCanvas.getWidth() / 2,
                                        top: tempCanvas.getHeight() / 2,
                                        originX: 'center',
                                        originY: 'center'
                                    });
                                    tempCanvas.add(tempGroup);
                                }
                                
                                tempCanvas.forEachObject(obj => {
                                    if (obj.fill === 'none' || obj.fill === null) {
                                        obj.set('fill', '#cccccc'); 
                                    }
                                });
                                
                                tempCanvas.renderAll();
                                const thumbnailDataUrl = tempCanvas.toDataURL({ format: 'png', quality: 0.5 }); 
                                tempCanvas.dispose();

                                savedTemplates = JSON.parse(localStorage.getItem(LOCAL_STORAGE_TEMPLATES_KEY) || '[]');
                                savedTemplates.push({ name: templateName, timestamp: new Date().toISOString(), data: JSON.stringify(templateData), thumbnail: thumbnailDataUrl });
                                localStorage.setItem(LOCAL_STORAGE_TEMPLATES_KEY, JSON.stringify(savedTemplates));
                                successfulUploads++;
                                
                            });

                        } catch (error) {
                            console.error(`Error processing file ${file.name}:`, error);
                            showNotification('error', 'Upload Error', `Could not process file "${file.name}". Ensure it is a valid JSON template. Details in console.`);
                        } finally {
                            processedCount++;
                            if (processedCount === files.length) {
                                showNotification('success', 'Upload Complete', `${successfulUploads} template(s) uploaded successfully.`);
                                e.target.value = ''; 
                                hideLoading(elements.openTemplateUploadInput); 
                                renderLocalTemplatesList(); 
                                hideSidePanel(); 
                            }
                        }
                    };
                    reader.readAsText(file);
                });
            });

            // --- Canvas Object Selection Event Handlers ---
            canvas.on('selection:updated', updateControlsForActiveObject);
            canvas.on('selection:created', updateControlsForActiveObject); 
            canvas.on('selection:cleared', clearControls);

            function updateControlsForActiveObject() {
                const activeObject = canvas.getActiveObject();
                elements.boldTextBtn.classList.remove('active');
                elements.italicTextBtn.classList.remove('active');
                elements.underlineTextBtn.classList.remove('active'); 
                [elements.alignLeftBtn, elements.alignCenterBtn, elements.alignRightBtn].forEach(btn => btn.classList.remove('active'));
                elements.textInput.value = '';
                elements.textOpacity.value = 1; 
                elements.textOpacityValue.textContent = '100%'; 


                if (activeObject) {
                    elements.textOpacity.value = activeObject.opacity || 1;
                    elements.textOpacityValue.textContent = `${Math.round((activeObject.opacity || 1) * 100)}%`;

                    if (activeObject.type === 'i-text' || activeObject.type === 'text') {
                        elements.fontFamily.value = activeObject.fontFamily || 'Cairo';
                        elements.fontSize.value = activeObject.fontSize || 30;
                        if (activeObject.fontWeight === 'bold') {
                            elements.boldTextBtn.classList.add('active');
                        }
                        if (activeObject.fontStyle === 'italic') {
                            elements.italicTextBtn.classList.add('active');
                        }
                        if (activeObject.underline === true) { 
                            elements.underlineTextBtn.classList.add('active');
                        }
                        if (activeObject.textAlign) {
                            if (activeObject.textAlign === 'left') elements.alignLeftBtn.classList.add('active');
                            if (activeObject.textAlign === 'center') elements.alignCenterBtn.classList.add('active');
                            if (activeObject.textAlign === 'right') elements.alignRightBtn.classList.add('active');
                        }
                        elements.textInput.value = activeObject.text;
                    } else { 
                         elements.fontFamily.value = 'Cairo'; 
                         elements.fontSize.value = 30; 
                         elements.textInput.value = ''; 
                    }
                    
                    let objectColor = '#1a1a1a'; 
                    if (activeObject.type === 'i-text' || activeObject.type === 'text' || activeObject.type === 'rect' || activeObject.type === 'circle' || activeObject.type === 'triangle') {
                        objectColor = activeObject.fill || '#1a1a1a';
                    } else if (activeObject.type === 'group' && activeObject.paths && activeObject.paths.length > 0) {
                        const firstFillablePath = activeObject.paths.find(path => path.fill && path.fill !== 'none');
                        objectColor = firstFillablePath ? firstFillablePath.fill : '#1a1a1a';
                    }
                    
                    elements.colorSwatches.forEach(s => s.classList.remove('active'));
                    const matchingSwatch = document.querySelector(`.color-swatch[data-color="${objectColor}"]`);
                    if (matchingSwatch) {
                        matchingSwatch.classList.add('active');
                    }
                    elements.customColorPicker.value = objectColor;

                } else {
                    clearControls();
                }
            }

            function clearControls() {
                elements.fontFamily.value = 'Cairo';
                elements.fontSize.value = 30;
                elements.textInput.value = '';
                elements.boldTextBtn.classList.remove('active');
                elements.italicTextBtn.classList.remove('active');
                elements.underlineTextBtn.classList.remove('active'); 
                [elements.alignLeftBtn, elements.alignCenterBtn, elements.alignRightBtn].forEach(btn => btn.classList.remove('active'));
                
                elements.colorSwatches.forEach(s => s.classList.remove('active'));
                document.querySelector('.color-swatch[data-color="#1a1a1a"]').classList.add('active');
                elements.customColorPicker.value = '#1a1a1a';

                elements.textOpacity.value = 1;
                elements.textOpacityValue.textContent = '100%';
            }

            // Initial setup - default canvas size
            function initializeCanvas() {
                setCanvasBackgroundAndSize(null); 
                document.querySelector('.color-swatch[data-color="#1a1a1a"]').classList.add('active');
                clearControls(); 
            }

            initializeCanvas();

            // Initial save of canvas state
            canvas.on('after:render', () => {
                if (historyPointer === -1) {
                    saveCanvasState();
                }
            });

            // --- Collapsible Sections (Accordion Behavior) for Text Panel ONLY ---
            function setupTextPanelAccordion() {
                const textPanel = document.querySelector('.text-controls-panel');
                if (!textPanel) return;

                const title = textPanel.querySelector('.section-title');
                const content = textPanel.querySelector('.section-content');

                if (title && content) {
                    title.addEventListener('click', () => {
                        if (window.innerWidth <= 1024) {
                            title.classList.toggle('collapsed');
                            const isCollapsed = title.classList.contains('collapsed');

                            if (!isCollapsed) {
                                content.classList.remove('hidden'); 
                                content.style.maxHeight = content.scrollHeight + 'px';
                                content.style.opacity = '1';
                                content.addEventListener('transitionend', function handler() {
                                    if (!title.classList.contains('collapsed')) {
                                        content.style.maxHeight = 'none'; 
                                    }
                                    content.removeEventListener('transitionend', handler);
                                });
                            } else {
                                content.style.maxHeight = content.scrollHeight + 'px'; 
                                requestAnimationFrame(() => {
                                    content.style.maxHeight = '0';
                                    content.style.opacity = '0';
                                    content.addEventListener('transitionend', function handler() {
                                        if (title.classList.contains('collapsed')) {
                                            content.classList.add('hidden'); 
                                        }
                                        content.removeEventListener('transitionend', handler);
                                    });
                                });
                            }
                        }
                    });
                }
            }
            setupTextPanelAccordion(); 

            // --- Side Panel Logic ---
            let activeSidePanel = null;

            function showSidePanel(panelId) {
                elements.menuButtons.forEach(btn => btn.classList.remove('active'));

                elements.sidePanels.forEach(panel => {
                    panel.classList.remove('show');
                });

                const targetPanel = document.getElementById(panelId);
                if (targetPanel) {
                    targetPanel.classList.add('show');
                    elements.sidePanelContainer.classList.add('show');
                    activeSidePanel = targetPanel;

                    const correspondingMenuBtn = document.querySelector(`.menu-btn[data-panel-target="${panelId}"]`);
                    if (correspondingMenuBtn) {
                        correspondingMenuBtn.classList.add('active');
                    }
                }
            }

            function hideSidePanel() {
                if (activeSidePanel) {
                    activeSidePanel.classList.remove('show');
                    activeSidePanel = null;
                }
                elements.sidePanelContainer.classList.remove('show');
                elements.menuButtons.forEach(btn => btn.classList.remove('active'));
            }

            elements.menuButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetPanelId = button.dataset.panelTarget;
                    if (activeSidePanel && activeSidePanel.id === targetPanelId) {
                        hideSidePanel();
                    } else {
                        showSidePanel(targetPanelId);
                    }
                });
            });

            elements.closeSidePanelButtons.forEach(button => {
                button.addEventListener('click', hideSidePanel);
            });

            elements.sidePanelContainer.addEventListener('click', (e) => {
                if (e.target === elements.sidePanelContainer) {
                    hideSidePanel();
                }
            });

            // --- Initial state on load and resize ---
            const applyInitialLayoutState = () => {
                const textControlsContent = document.getElementById('textControls');
                const textControlsTitle = textControlsContent.previousElementSibling; 

                if (window.innerWidth > 1024) { 
                    textControlsContent.classList.remove('hidden');
                    textControlsContent.style.maxHeight = 'none'; 
                    textControlsContent.style.opacity = '1';
                    textControlsTitle.classList.remove('collapsed');
                    textControlsTitle.querySelector('i').style.display = 'none'; 
                    textControlsTitle.style.cursor = 'default';
                } else { 
                    textControlsContent.classList.add('hidden');
                    textControlsContent.style.maxHeight = '0';
                    textControlsContent.style.opacity = '0';
                    textControlsTitle.classList.add('collapsed');
                    textControlsTitle.querySelector('i').style.display = 'inline-block';
                    textControlsTitle.style.cursor = 'pointer';
                }

                hideSidePanel();
            };

            applyInitialLayoutState();
            window.addEventListener('resize', applyInitialLayoutState);


            // --- Undo/Redo Button Handlers ---
            elements.undoBtn.addEventListener('click', undoCanvas);
            elements.redoBtn.addEventListener('click', redoCanvas);

            // --- Keyboard Shortcuts ---
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    const focusedElement = document.activeElement;
                    if (focusedElement && (focusedElement.tagName === 'INPUT' || focusedElement.tagName === 'TEXTAREA')) {
                        return; 
                    }
                    if (canvas.getActiveObject() || canvas.getActiveObjects().length > 0) {
                        elements.deleteObjectBtn.click();
                        e.preventDefault();
                    }
                } else if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                    undoCanvas();
                    e.preventDefault();
                } else if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key === 'Z'))) {
                    redoCanvas();
                    e.preventDefault();
                }
            });
        });
    </script>
</body>
</html>